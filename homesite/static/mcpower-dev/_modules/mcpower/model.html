<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">

    <!-- Generated with Sphinx 7.4.7 and Furo 2025.12.19 -->
        <title>mcpower.model - MCPower</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=d26f3b38" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-brand-primary: #5B4460;
  --color-brand-content: #5B4460;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #B88FC2;
  --color-brand-content: #B88FC2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #B88FC2;
  --color-brand-content: #B88FC2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">MCPower</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="https://freestylerscientist.pl/">
  <span style="font-size: 0.85em; color: var(--color-foreground-secondary);">
    by <strong>Paweł Lenartowicz</strong>
  </span>
</a>
<div style="margin-top: 0.5em; font-size: 0.8em;">
  <a href="https://freestylerscientist.pl/about-me/" style="color: var(--color-foreground-muted);">About the author</a>
  &nbsp;&middot;&nbsp;
  <a href="https://freestylerscientist.pl/support_me/" style="color: var(--color-foreground-muted);">Support this project</a>
</div><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a><input aria-label="Toggle navigation of Tutorials" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/first-analysis.html">Tutorial: Your First Power Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/sample-size.html">Tutorial: Finding the Right Sample Size</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/interactions.html">Tutorial: Testing Interactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/correlations.html">Tutorial: Correlated Predictors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/own-data.html">Tutorial: Power Analysis with Your Own Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/csv-preparation.html">Tutorial: Preparing Your CSV for MCPower</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/anova-posthoc.html">Tutorial: ANOVA &amp; Post-Hoc Pairwise Comparisons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/multiple-testing.html">Tutorial: Controlling for Multiple Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/mixed-intercepts.html">Tutorial: Random Intercepts for Clustered Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/mixed-slopes.html">Tutorial: Random Slopes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/mixed-nested.html">Tutorial: Nested Random Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/test-formula.html">Tutorial: Using test_formula</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/custom-scenarios.html">Tutorial: Using Custom Scenarios</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../concepts/index.html">Concepts</a><input aria-label="Toggle navigation of Concepts" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/effect-sizes.html">Effect Sizes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/variable-types.html">Variable Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/correlations.html">Correlations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/scenario-analysis.html">Scenario Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/mixed-effects.html">Mixed-Effects Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/performance.html">Performance</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/constructor.html">MCPower() Constructor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/power-analysis.html">Power Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/configuration.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/data.html">Data &amp; Clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/scenarios.html">Scenario Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/corrections.html">Correction Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/progress.html">Progress Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/return-values.html">Return Values</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../model-specification.html">Model Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../limitations.html">Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../validation.html">How It Is Validated</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lme-validation.html">LME Validation (vs R’s lme4)</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for mcpower.model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MCPower - Monte Carlo Power Analysis.</span>

<span class="sd">This module provides the main MCPower class for conducting power analysis</span>
<span class="sd">using Monte Carlo simulations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_backend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.core</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DEFAULT_SCENARIO_CONFIG</span><span class="p">,</span>
    <span class="n">ResultsProcessor</span><span class="p">,</span>
    <span class="n">ScenarioRunner</span><span class="p">,</span>
    <span class="n">SimulationRunner</span><span class="p">,</span>
    <span class="n">VariableRegistry</span><span class="p">,</span>
    <span class="n">apply_per_simulation_perturbations</span><span class="p">,</span>
    <span class="n">build_power_result</span><span class="p">,</span>
    <span class="n">build_sample_size_result</span><span class="p">,</span>
    <span class="n">prepare_metadata</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.stats.ols</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_critical_values</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.formatters</span><span class="w"> </span><span class="kn">import</span> <span class="n">_format_results</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.upload_data_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">normalize_upload_input</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_validate_alpha</span><span class="p">,</span>
    <span class="n">_validate_correction_method</span><span class="p">,</span>
    <span class="n">_validate_correlation_matrix</span><span class="p">,</span>
    <span class="n">_validate_model_ready</span><span class="p">,</span>
    <span class="n">_validate_parallel_settings</span><span class="p">,</span>
    <span class="n">_validate_power</span><span class="p">,</span>
    <span class="n">_validate_sample_size</span><span class="p">,</span>
    <span class="n">_validate_sample_size_for_model</span><span class="p">,</span>
    <span class="n">_validate_sample_size_range</span><span class="p">,</span>
    <span class="n">_validate_simulations</span><span class="p">,</span>
    <span class="n">_validate_upload_data</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">_create_power_plot</span>


<div class="viewcode-block" id="MCPower">
<a class="viewcode-back" href="../../api/constructor.html#mcpower.MCPower">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MCPower</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monte Carlo Power Analysis.</span>

<span class="sd">    Conducts simulation-based power analysis for linear regression and</span>
<span class="sd">    linear mixed-effects models. Supports continuous, binary, and factor</span>
<span class="sd">    predictors, interactions, correlated predictors, non-normal distributions,</span>
<span class="sd">    and empirical data upload.</span>

<span class="sd">    All configuration methods (``set_*``) use deferred application: settings</span>
<span class="sd">    are stored as pending and processed in the correct order when ``apply()``</span>
<span class="sd">    is called (or automatically before ``find_power``/``find_sample_size``).</span>
<span class="sd">    Most ``set_*`` methods return ``self`` for method chaining.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        seed: Random seed for reproducibility (default: 2137).</span>
<span class="sd">        power: Target power level in percent (default: 80.0).</span>
<span class="sd">        alpha: Significance level (default: 0.05).</span>
<span class="sd">        n_simulations: Number of Monte Carlo simulations for OLS (default: 1600).</span>
<span class="sd">        n_simulations_mixed_model: Simulations for mixed models (default: 800).</span>
<span class="sd">        parallel: Parallel processing mode (default: ``&quot;mixedmodels&quot;``).</span>
<span class="sd">        n_cores: Number of CPU cores for parallel execution.</span>
<span class="sd">        max_failed_simulations: Maximum acceptable failure rate (default: 0.03).</span>
<span class="sd">        heterogeneity: Standard deviation for random effect-size perturbation.</span>
<span class="sd">        heteroskedasticity: Correlation between predictor and error variance.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; model = MCPower(&quot;y = x1 + x2 + x1:x2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; model.set_effects(&quot;x1=0.5, x2=0.3, x1:x2=0.2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; model.find_power(sample_size=100)</span>

<span class="sd">        &gt;&gt;&gt; # Mixed model with clustered data</span>
<span class="sd">        &gt;&gt;&gt; model = MCPower(&quot;y ~ treatment + motivation + (1|school)&quot;)</span>
<span class="sd">        &gt;&gt;&gt; model.set_cluster(&quot;school&quot;, ICC=0.2, n_clusters=20)</span>
<span class="sd">        &gt;&gt;&gt; model.set_effects(&quot;treatment=0.5, motivation=0.3&quot;)</span>
<span class="sd">        &gt;&gt;&gt; model.find_power(sample_size=1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_generation_formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize Monte Carlo Power Analysis.</span>

<span class="sd">        Parses the formula, creates the variable registry, and sets all</span>
<span class="sd">        configuration attributes to their defaults. If the formula contains</span>
<span class="sd">        random effects (e.g. ``(1|school)``), the model is automatically</span>
<span class="sd">        configured for mixed-model generation and a warning is issued.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_generation_formula: R-style formula specifying the model.</span>
<span class="sd">                Supports ``=`` or ``~`` separators, ``+`` for additive terms,</span>
<span class="sd">                ``:`` for interactions, and ``(1|group)`` for random intercepts.</span>
<span class="sd">                Examples: ``&quot;y = x1 + x2 + x1:x2&quot;``,</span>
<span class="sd">                ``&quot;score ~ treatment + age + (1|school)&quot;``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Formula types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generation_method</span> <span class="o">=</span> <span class="s2">&quot;linear_regression&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_method</span> <span class="o">=</span> <span class="s2">&quot;linear_regression&quot;</span>

        <span class="c1"># Core configuration (applied immediately)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2137</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="mf">80.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_simulations</span> <span class="o">=</span> <span class="mi">1600</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_simulations_mixed_model</span> <span class="o">=</span> <span class="mi">800</span>

        <span class="c1"># Parallel processing</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mixedmodels&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Simulation failure tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_failed_simulations</span> <span class="o">=</span> <span class="mf">0.03</span>  <span class="c1"># 3% default</span>

        <span class="c1"># Variable registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="n">VariableRegistry</span><span class="p">(</span><span class="n">data_generation_formula</span><span class="p">)</span>

        <span class="c1"># Scenario configurations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario_configs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Pending inputs (deferred until apply())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_variable_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_factor_levels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_effects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_correlations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {grouping_var: {n_clusters, cluster_size, icc}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_effects_set</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True after set_effects() has been called</span>

        <span class="c1"># Detect mixed model formula</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_random_effects_parsed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generation_method</span> <span class="o">=</span> <span class="s2">&quot;mixed_model&quot;</span>

        <span class="c1"># Applied state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Data storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_normal_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_data_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_raw_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_data_n</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Sample count for warning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preserve_correlation</span> <span class="o">=</span> <span class="s2">&quot;strict&quot;</span>  <span class="c1"># Default mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_var_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Post-hoc tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_posthoc_specs</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Phase 2 Optimization: Effect plan cache for _create_X_extended</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_effect_plan_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># Formula properties</span>
    <span class="c1"># =========================================================================</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">model_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Human-readable string showing the generation and test methods.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Generation method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_generation_method</span><span class="si">}</span><span class="s2">, Test method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_method</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># Model properties</span>
    <span class="c1"># =========================================================================</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">equation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Original equation string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">equation</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Correlation matrix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_correlation_matrix</span><span class="p">()</span>

    <span class="nd">@correlation_matrix</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_correlation_matrix</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predictor_vars_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predictor variable order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">non_factor_names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">dummy_names</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># Configuration methods</span>
    <span class="c1"># =========================================================================</span>

<div class="viewcode-block" id="MCPower.set_parallel">
<a class="viewcode-back" href="../../api/configuration.html#mcpower.MCPower.set_parallel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">n_cores</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable or disable parallel processing.</span>

<span class="sd">        Requires ``joblib`` to be installed. Falls back to sequential</span>
<span class="sd">        processing with a warning if ``joblib`` is unavailable.</span>

<span class="sd">        Args:</span>
<span class="sd">            enable: Parallel mode — ``True`` for all analyses,</span>
<span class="sd">                ``False`` for sequential processing, or</span>
<span class="sd">                ``&quot;mixedmodels&quot;`` for mixed-model analyses only (default).</span>
<span class="sd">            n_cores: Number of CPU cores to use. Defaults to</span>
<span class="sd">                ``cpu_count // 2``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">enable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># enable is True or &quot;mixedmodels&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>  <span class="c1"># noqa: F401 — availability check only</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: joblib not available. Install with: pip install joblib&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Continuing with sequential processing.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">settings</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_parallel_settings</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">n_cores</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_seed">
<a class="viewcode-back" href="../../api/configuration.html#mcpower.MCPower.set_seed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set random seed for reproducibility.</span>

<span class="sd">        Args:</span>
<span class="sd">            seed: Non-negative integer up to 3,000,000,000.</span>
<span class="sd">                Pass ``None`` to enable fully random seeding.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If *seed* is not an integer or ``None``.</span>
<span class="sd">            ValueError: If *seed* is negative or exceeds the maximum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;seed must be an integer or None&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;seed must be non-negative&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="mi">3000000000</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;seed must be lower than 3,000,000,000&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seed set to: </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Random seeding enabled&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_power">
<a class="viewcode-back" href="../../api/configuration.html#mcpower.MCPower.set_power">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the target statistical power level.</span>

<span class="sd">        Used by ``find_sample_size`` to determine when power is sufficient.</span>

<span class="sd">        Args:</span>
<span class="sd">            power: Target power as a percentage (0–100). Default is 80.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *power* is outside the valid range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_power</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_alpha">
<a class="viewcode-back" href="../../api/configuration.html#mcpower.MCPower.set_alpha">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the significance level for hypothesis testing.</span>

<span class="sd">        Args:</span>
<span class="sd">            alpha: Type-I error rate (0–0.25). Default is 0.05.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *alpha* is outside the valid range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_alpha</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_simulations">
<a class="viewcode-back" href="../../api/configuration.html#mcpower.MCPower.set_simulations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_simulations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the number of Monte Carlo simulations.</span>

<span class="sd">        More simulations yield more precise power estimates at the cost of</span>
<span class="sd">        longer runtime. The default is 1600 for OLS and 800 for mixed models.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_simulations: Number of simulations (positive integer).</span>
<span class="sd">            model_type: Which simulation count to update:</span>
<span class="sd">                - ``None`` (default): sets both OLS and mixed-model counts.</span>
<span class="sd">                - ``&quot;linear&quot;``: sets only the OLS count.</span>
<span class="sd">                - ``&quot;mixed&quot;``: sets only the mixed-model count.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *n_simulations* is not a positive integer or</span>
<span class="sd">                *model_type* is unrecognised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_warnings</span>

        <span class="n">n_sims</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_simulations</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
            <span class="n">_warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_simulations</span> <span class="o">=</span> <span class="n">n_sims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_simulations_mixed_model</span> <span class="o">=</span> <span class="n">n_sims</span>
        <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_simulations</span> <span class="o">=</span> <span class="n">n_sims</span>
        <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;mixed&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_simulations_mixed_model</span> <span class="o">=</span> <span class="n">n_sims</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_type must be None, &#39;linear&#39;, or &#39;mixed&#39;, got &#39;</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_effective_n_simulations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the simulation count appropriate for the current test method.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_method</span> <span class="o">==</span> <span class="s2">&quot;mixed_model&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_simulations_mixed_model</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_simulations</span>

<div class="viewcode-block" id="MCPower.set_max_failed_simulations">
<a class="viewcode-back" href="../../api/scenarios.html#mcpower.MCPower.set_max_failed_simulations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_max_failed_simulations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the maximum acceptable proportion of failed simulations.</span>

<span class="sd">        When a simulation iteration fails (e.g. due to convergence issues in</span>
<span class="sd">        mixed models), it is discarded. If the failure rate exceeds this</span>
<span class="sd">        threshold, the analysis raises an error rather than returning</span>
<span class="sd">        unreliable results.</span>

<span class="sd">        Args:</span>
<span class="sd">            percentage: Maximum failure rate as a proportion (0–1).</span>
<span class="sd">                Default is 0.03 (3%). For mixed models with small samples</span>
<span class="sd">                or high ICC, consider raising to 0.10.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *percentage* is not between 0 and 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">percentage</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;percentage must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_failed_simulations</span> <span class="o">=</span> <span class="n">percentage</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_effects">
<a class="viewcode-back" href="../../api/configuration.html#mcpower.MCPower.set_effects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">effects_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set standardised effect sizes for predictors.</span>

<span class="sd">        Effect sizes are expressed as standardised regression coefficients</span>
<span class="sd">        (beta weights). Each assignment maps an effect name to its size.</span>
<span class="sd">        Interaction effects use ``:`` notation. For factor variables, specify</span>
<span class="sd">        effects for each dummy level with bracket notation.</span>

<span class="sd">        This setting is deferred until ``apply()`` is called.</span>

<span class="sd">        Args:</span>
<span class="sd">            effects_string: Comma-separated ``name=value`` pairs.</span>
<span class="sd">                Examples: ``&quot;x1=0.5, x2=0.3, x1:x2=0.2&quot;``,</span>
<span class="sd">                ``&quot;treatment=0.4, cyl[2]=0.2, cyl[3]=0.5&quot;``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If *effects_string* is not a string.</span>
<span class="sd">            ValueError: If *effects_string* is empty or contains invalid</span>
<span class="sd">                assignments (checked at apply time).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effects_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;effects_string must be a string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">effects_string</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;effects_string cannot be empty&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_effects</span> <span class="o">=</span> <span class="n">effects_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_effects_set</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_correlations">
<a class="viewcode-back" href="../../api/configuration.html#mcpower.MCPower.set_correlations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_correlations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correlations_input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set correlations between predictor variables.</span>

<span class="sd">        Correlations are only defined for non-factor (continuous/binary)</span>
<span class="sd">        predictors. Factor dummies are generated independently.</span>

<span class="sd">        This setting is deferred until ``apply()`` is called.</span>

<span class="sd">        Args:</span>
<span class="sd">            correlations_input: Either a comma-separated string of pair-wise</span>
<span class="sd">                assignments (e.g. ``&quot;x1:x2=0.3, x1:x3=-0.1&quot;``) or a full</span>
<span class="sd">                NumPy correlation matrix whose dimensions match the number</span>
<span class="sd">                of non-factor predictors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If *correlations_input* is not a string or ndarray.</span>
<span class="sd">            ValueError: If the matrix is not positive semi-definite or has</span>
<span class="sd">                wrong dimensions (checked at apply time).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">correlations_input</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;correlations_input must be string or numpy array&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_correlations</span> <span class="o">=</span> <span class="n">correlations_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_variable_type">
<a class="viewcode-back" href="../../api/configuration.html#mcpower.MCPower.set_variable_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_variable_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_types_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set distribution types for predictor variables.</span>

<span class="sd">        Variables default to ``&quot;normal&quot;`` (standard Gaussian). Use this</span>
<span class="sd">        method to specify alternative distributions.</span>

<span class="sd">        This setting is deferred until ``apply()`` is called.</span>

<span class="sd">        Args:</span>
<span class="sd">            variable_types_string: Comma-separated ``name=type`` assignments.</span>
<span class="sd">                Supported types:</span>

<span class="sd">                - ``&quot;normal&quot;`` — standard normal (default).</span>
<span class="sd">                - ``&quot;binary&quot;`` or ``&quot;binary(p)&quot;`` — Bernoulli with proportion *p*</span>
<span class="sd">                  (default 0.5).</span>
<span class="sd">                - ``&quot;right_skewed&quot;`` — positively skewed distribution.</span>
<span class="sd">                - ``&quot;left_skewed&quot;`` — negatively skewed distribution.</span>
<span class="sd">                - ``&quot;high_kurtosis&quot;`` — heavy-tailed (t-distribution, df=3).</span>
<span class="sd">                - ``&quot;uniform&quot;`` — uniform distribution.</span>
<span class="sd">                - ``&quot;factor(k)&quot;`` — categorical with *k* levels (creates *k-1*</span>
<span class="sd">                  dummy variables).</span>
<span class="sd">                - ``&quot;factor(k, p1, p2, ...)&quot;`` — factor with custom level</span>
<span class="sd">                  proportions.</span>

<span class="sd">                Example: ``&quot;x1=binary, x2=right_skewed, x3=factor(3)&quot;``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If *variable_types_string* is not a string.</span>
<span class="sd">            ValueError: If types are unrecognised or proportions invalid</span>
<span class="sd">                (checked at apply time).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_types_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;variable_types_string must be a string&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_variable_types</span> <span class="o">=</span> <span class="n">variable_types_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_factor_levels">
<a class="viewcode-back" href="../../api/data.html#mcpower.MCPower.set_factor_levels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_factor_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define named factor levels without uploaded data.</span>

<span class="sd">        The first listed level becomes the reference level.</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: Factor definitions. Format: ``&quot;var=level1,level2,level3&quot;``.</span>
<span class="sd">                Multiple factors separated by ``;``:</span>
<span class="sd">                ``&quot;group=control,drug_a; dose=low,medium,high&quot;``</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If *spec* is not a string.</span>
<span class="sd">            ValueError: If variable not in formula, or fewer than 2 levels</span>
<span class="sd">                (checked at apply time).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;spec must be a string&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_factor_levels</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_cluster">
<a class="viewcode-back" href="../../api/data.html#mcpower.MCPower.set_cluster">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_cluster</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ICC</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_clusters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cluster_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">random_slopes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slope_variance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">slope_intercept_corr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">n_per_parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure a cluster/grouping variable for random effects.</span>

<span class="sd">        Sets up the clustering structure for a linear mixed-effects model.</span>
<span class="sd">        The grouping variable must correspond to a random-effect term in</span>
<span class="sd">        the formula. Specify either *n_clusters* or *cluster_size* — the</span>
<span class="sd">        other is derived from the sample size at analysis time.</span>

<span class="sd">        This setting is deferred until ``apply()`` is called.</span>

<span class="sd">        Args:</span>
<span class="sd">            grouping_var: Name of the grouping variable (must match a</span>
<span class="sd">                random-effect term in the formula).</span>
<span class="sd">            ICC: Intraclass correlation coefficient (0 &lt;= ICC &lt; 1).</span>
<span class="sd">                Determines the proportion of total variance attributable</span>
<span class="sd">                to between-cluster differences. Required for non-nested</span>
<span class="sd">                terms; for nested child terms, specifies the child-level</span>
<span class="sd">                ICC.</span>
<span class="sd">            n_clusters: Number of clusters. Mutually exclusive with</span>
<span class="sd">                *cluster_size*. Not required for nested child terms</span>
<span class="sd">                (derived from parent).</span>
<span class="sd">            cluster_size: Number of observations per cluster. Mutually</span>
<span class="sd">                exclusive with *n_clusters*.</span>
<span class="sd">            random_slopes: List of predictor names with random slopes.</span>
<span class="sd">                Requires a ``(1 + x|group)`` term in the formula.</span>
<span class="sd">            slope_variance: Between-cluster variance of the random slope.</span>
<span class="sd">                Only meaningful when *random_slopes* is set.</span>
<span class="sd">            slope_intercept_corr: Correlation between random intercept and</span>
<span class="sd">                random slope. Must be in [-1, 1].</span>
<span class="sd">            n_per_parent: Number of sub-groups per parent group (required</span>
<span class="sd">                for nested effects when the formula has ``(1|A/B)``).</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *grouping_var* is not in the formula, both or</span>
<span class="sd">                neither of *n_clusters*/*cluster_size* are given, *ICC*</span>
<span class="sd">                is out of range, or slope parameters are invalid.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Random intercept only (backward compatible)</span>
<span class="sd">            &gt;&gt;&gt; model = MCPower(&quot;y ~ x1 + x2 + (1|school)&quot;)</span>
<span class="sd">            &gt;&gt;&gt; model.set_cluster(&quot;school&quot;, ICC=0.2, n_clusters=20)</span>

<span class="sd">            &gt;&gt;&gt; # Random slopes with correlation</span>
<span class="sd">            &gt;&gt;&gt; model = MCPower(&quot;y ~ x1 + (1 + x1|school)&quot;)</span>
<span class="sd">            &gt;&gt;&gt; model.set_cluster(&quot;school&quot;, ICC=0.2, n_clusters=20,</span>
<span class="sd">            ...     random_slopes=[&quot;x1&quot;], slope_variance=0.1,</span>
<span class="sd">            ...     slope_intercept_corr=0.3)</span>

<span class="sd">            &gt;&gt;&gt; # Nested: formula has (1|school/classroom)</span>
<span class="sd">            &gt;&gt;&gt; model = MCPower(&quot;y ~ treatment + (1|school/classroom)&quot;)</span>
<span class="sd">            &gt;&gt;&gt; model.set_cluster(&quot;school&quot;, ICC=0.15, n_clusters=10)</span>
<span class="sd">            &gt;&gt;&gt; model.set_cluster(&quot;classroom&quot;, ICC=0.10, n_per_parent=3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">_validate_cluster_config</span>

        <span class="c1"># Determine if this is a nested child term</span>
        <span class="n">parsed_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_random_effects_parsed</span>
        <span class="n">parsed_grouping_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">[</span><span class="s2">&quot;grouping_var&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="n">parsed_re</span><span class="p">]</span>

        <span class="c1"># For nested child terms, find the parent and map to the composite name</span>
        <span class="n">parent_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">actual_grouping_var</span> <span class="o">=</span> <span class="n">grouping_var</span>

        <span class="c1"># Check if this grouping_var is a child of a nested term</span>
        <span class="k">for</span> <span class="n">re_spec</span> <span class="ow">in</span> <span class="n">parsed_re</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_var&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re_spec</span><span class="p">[</span><span class="s2">&quot;grouping_var&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">parent_var</span> <span class="o">=</span> <span class="n">re_spec</span><span class="p">[</span><span class="s2">&quot;parent_var&quot;</span><span class="p">]</span>
                <span class="n">actual_grouping_var</span> <span class="o">=</span> <span class="n">re_spec</span><span class="p">[</span><span class="s2">&quot;grouping_var&quot;</span><span class="p">]</span>  <span class="c1"># e.g. &quot;school:classroom&quot;</span>
                <span class="k">break</span>

        <span class="c1"># Set default ICC</span>
        <span class="k">if</span> <span class="n">ICC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ICC</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># For nested child terms, n_clusters/cluster_size are derived from parent</span>
        <span class="k">if</span> <span class="n">parent_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cluster_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;For nested child variable &#39;</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;, n_clusters and cluster_size &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;are derived from the parent &#39;</span><span class="si">{</span><span class="n">parent_var</span><span class="si">}</span><span class="s2">&#39;. Use n_per_parent instead.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">n_per_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;n_per_parent is required for nested child variable &#39;</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;This specifies how many &#39;</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39; groups exist within each &#39;</span><span class="si">{</span><span class="n">parent_var</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Validate using parent&#39;s grouping var as the target</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_cluster_config</span><span class="p">(</span><span class="n">actual_grouping_var</span><span class="p">,</span> <span class="n">ICC</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">parsed_grouping_vars</span><span class="p">,</span> <span class="n">nested_child</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_cluster_config</span><span class="p">(</span><span class="n">actual_grouping_var</span><span class="p">,</span> <span class="n">ICC</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">,</span> <span class="n">cluster_size</span><span class="p">,</span> <span class="n">parsed_grouping_vars</span><span class="p">)</span>

        <span class="n">result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="c1"># Validate slope parameters</span>
        <span class="k">if</span> <span class="n">slope_variance</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">random_slopes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;slope_variance &gt; 0 requires random_slopes to be set&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">slope_intercept_corr</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;slope_intercept_corr must be in [-1, 1]&quot;</span><span class="p">)</span>

        <span class="c1"># Store pending configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="p">[</span><span class="n">actual_grouping_var</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;n_clusters&quot;</span><span class="p">:</span> <span class="n">n_clusters</span><span class="p">,</span>
            <span class="s2">&quot;cluster_size&quot;</span><span class="p">:</span> <span class="n">cluster_size</span><span class="p">,</span>
            <span class="s2">&quot;icc&quot;</span><span class="p">:</span> <span class="n">ICC</span><span class="p">,</span>
            <span class="s2">&quot;random_slopes&quot;</span><span class="p">:</span> <span class="n">random_slopes</span><span class="p">,</span>
            <span class="s2">&quot;slope_variance&quot;</span><span class="p">:</span> <span class="n">slope_variance</span><span class="p">,</span>
            <span class="s2">&quot;slope_intercept_corr&quot;</span><span class="p">:</span> <span class="n">slope_intercept_corr</span><span class="p">,</span>
            <span class="s2">&quot;parent_var&quot;</span><span class="p">:</span> <span class="n">parent_var</span><span class="p">,</span>
            <span class="s2">&quot;n_per_parent&quot;</span><span class="p">:</span> <span class="n">n_per_parent</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.upload_data">
<a class="viewcode-back" href="../../api/data.html#mcpower.MCPower.upload_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upload_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">preserve_correlation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;strict&quot;</span><span class="p">,</span>
        <span class="n">data_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">preserve_factor_level_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload empirical data to preserve distribution shapes (deferred until apply()).</span>

<span class="sd">        The uploaded data&#39;s distribution will be used for generating simulated</span>
<span class="sd">        data. Auto-detects variable types based on unique value counts:</span>
<span class="sd">        - 1 unique value: dropped (constant)</span>
<span class="sd">        - 2 unique values: binary</span>
<span class="sd">        - 3-6 unique values: factor</span>
<span class="sd">        - 7+ unique values: continuous</span>

<span class="sd">        Args:</span>
<span class="sd">            data: Empirical data as:</span>
<span class="sd">                - dict of {var_name: array} - keys are variable names</span>
<span class="sd">                - numpy array (n_samples, n_vars) or (n_samples,) for single variable</span>
<span class="sd">                - list (1D or 2D)</span>
<span class="sd">                - pandas DataFrame - column names used automatically (requires pandas)</span>
<span class="sd">                When columns is not provided for array/list input, variables are</span>
<span class="sd">                auto-named column_1, column_2, etc.</span>
<span class="sd">            columns: Variable names for numpy/list columns (optional; auto-generated if omitted)</span>
<span class="sd">            preserve_correlation: How to handle correlations between uploaded variables:</span>
<span class="sd">                - &#39;no&#39;: No correlation preservation (default generation)</span>
<span class="sd">                - &#39;partial&#39;: Compute correlations from data, merge with user correlations</span>
<span class="sd">                - &#39;strict&#39;: Bootstrap whole rows to preserve exact relationships (default)</span>
<span class="sd">            data_types: Override auto-detection for specific variables.</span>
<span class="sd">                Simple: {&quot;hp&quot;: &quot;continuous&quot;, &quot;cyl&quot;: &quot;factor&quot;}</span>
<span class="sd">                With reference level: {&quot;cyl&quot;: (&quot;factor&quot;, 8)} or {&quot;origin&quot;: (&quot;factor&quot;, &quot;USA&quot;)}</span>
<span class="sd">                Valid types: &quot;binary&quot;, &quot;factor&quot;, &quot;continuous&quot;</span>
<span class="sd">            preserve_factor_level_names: When True (default), factor dummy variables</span>
<span class="sd">                use original data values as level names (e.g., cyl[6], cyl[8]).</span>
<span class="sd">                When False, uses integer indices (e.g., cyl[2], cyl[3]).</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Using dict (no extra dependencies needed)</span>
<span class="sd">            &gt;&gt;&gt; import csv</span>
<span class="sd">            &gt;&gt;&gt; with open(&quot;my_data.csv&quot;) as f:</span>
<span class="sd">            ...     reader = csv.DictReader(f)</span>
<span class="sd">            ...     raw = list(reader)</span>
<span class="sd">            &gt;&gt;&gt; data = {col: [float(r[col]) for r in raw] for col in [&quot;x1&quot;, &quot;x2&quot;]}</span>
<span class="sd">            &gt;&gt;&gt; model.upload_data(data)</span>

<span class="sd">            &gt;&gt;&gt; # Using numpy array with strict correlation preservation</span>
<span class="sd">            &gt;&gt;&gt; model.upload_data(</span>
<span class="sd">            ...     np.array([[1,2], [3,4], [5,6]]),</span>
<span class="sd">            ...     columns=[&quot;x1&quot;, &quot;x2&quot;],</span>
<span class="sd">            ...     preserve_correlation=&quot;strict&quot;</span>
<span class="sd">            ... )</span>

<span class="sd">            &gt;&gt;&gt; # Using pandas DataFrame (requires: pip install pandas)</span>
<span class="sd">            &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">            &gt;&gt;&gt; df = pd.read_csv(&quot;my_data.csv&quot;)</span>
<span class="sd">            &gt;&gt;&gt; model.upload_data(df[[&quot;x1&quot;, &quot;x2&quot;]])</span>

<span class="sd">            &gt;&gt;&gt; # Override auto-detection</span>
<span class="sd">            &gt;&gt;&gt; model.upload_data(data, data_types={&quot;cyl&quot;: &quot;factor&quot;, &quot;hp&quot;: &quot;continuous&quot;})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate preserve_correlation</span>
        <span class="n">valid_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;partial&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">preserve_correlation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;preserve_correlation must be one of </span><span class="si">{</span><span class="n">valid_modes</span><span class="si">}</span><span class="s2">, got &#39;</span><span class="si">{</span><span class="n">preserve_correlation</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Convert to standard format: numpy array + column names</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">normalize_upload_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Validate data</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_upload_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="c1"># Validate data_types if provided</span>
        <span class="k">if</span> <span class="n">data_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valid_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;factor&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">data_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tuple data_type for &#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&#39; must have 2 elements: (type, reference_level)&quot;</span><span class="p">)</span>
                    <span class="n">actual_type</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">actual_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type &#39;</span><span class="si">{</span><span class="n">actual_type</span><span class="si">}</span><span class="s2">&#39; for variable &#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&#39;. Must be one of </span><span class="si">{</span><span class="n">valid_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type &#39;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&#39; for variable &#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&#39;. Must be one of </span><span class="si">{</span><span class="n">valid_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&#39; in data_types not found in data columns: </span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Warn about very small uploaded datasets (&gt;=25 passes validation,</span>
        <span class="c1"># but &lt;30 is still marginal for bootstrap resampling)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: Uploaded data has only </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> observations. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Bootstrap resampling from fewer than 30 observations may produce &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;unreliable distributional estimates.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">columns</span><span class="p">,</span>
            <span class="s2">&quot;preserve_correlation&quot;</span><span class="p">:</span> <span class="n">preserve_correlation</span><span class="p">,</span>
            <span class="s2">&quot;data_types&quot;</span><span class="p">:</span> <span class="n">data_types</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="s2">&quot;uploaded_n&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;preserve_factor_level_names&quot;</span><span class="p">:</span> <span class="n">preserve_factor_level_names</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MCPower.set_scenario_configs">
<a class="viewcode-back" href="../../api/scenarios.html#mcpower.MCPower.set_scenario_configs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_scenario_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configs_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set custom scenario configurations for robustness analysis.</span>

<span class="sd">        Scenario analysis (enabled via ``scenarios=True`` in ``find_power``</span>
<span class="sd">        or ``find_sample_size``) runs the simulation under multiple</span>
<span class="sd">        assumption-violation profiles. The defaults define ``&quot;realistic&quot;``</span>
<span class="sd">        and ``&quot;doomer&quot;`` scenarios; use this method to override or add</span>
<span class="sd">        custom scenarios.</span>

<span class="sd">        Provided configs are merged with the defaults: existing scenario</span>
<span class="sd">        keys are updated, new keys are added.</span>

<span class="sd">        Args:</span>
<span class="sd">            configs_dict: Mapping of scenario names to configuration dicts.</span>
<span class="sd">                Each configuration may include keys such as</span>
<span class="sd">                ``&quot;heterogeneity&quot;``, ``&quot;heteroskedasticity&quot;``,</span>
<span class="sd">                ``&quot;correlation_noise_sd&quot;``, and ``&quot;distribution_change_prob&quot;``.</span>
<span class="sd">                See ``DEFAULT_SCENARIO_CONFIG`` in ``mcpower.core.scenarios``</span>
<span class="sd">                for the full list of keys.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: For method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If *configs_dict* is not a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configs_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;configs_dict must be a dictionary&quot;</span><span class="p">)</span>

        <span class="n">merged</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">DEFAULT_SCENARIO_CONFIG</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">configs_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># New custom scenarios inherit all keys from optimistic baseline</span>
                <span class="n">merged</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">DEFAULT_SCENARIO_CONFIG</span><span class="p">[</span><span class="s2">&quot;optimistic&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario_configs</span> <span class="o">=</span> <span class="n">merged</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Custom scenario configs set: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configs_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="c1"># =========================================================================</span>
    <span class="c1"># Apply method (processes all pending settings)</span>
    <span class="c1"># =========================================================================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply all pending settings to the model.</span>

<span class="sd">        Processes settings in the correct order:</span>
<span class="sd">        1. Variable types</span>
<span class="sd">        2. Factor level definitions</span>
<span class="sd">        3. Expand factors into dummy variables</span>
<span class="sd">        4. Cluster configurations (random effects)</span>
<span class="sd">        5. Uploaded data (sets variable types to uploaded_data)</span>
<span class="sd">        6. Effects</span>
<span class="sd">        7. Correlations</span>
<span class="sd">        8. Heterogeneity/heteroskedasticity</span>

<span class="sd">        This method is called automatically before find_power() or find_sample_size()</span>
<span class="sd">        if any settings have changed since the last apply().</span>

<span class="sd">        Returns:</span>
<span class="sd">            self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.parsers</span><span class="w"> </span><span class="kn">import</span> <span class="n">_parser</span>

        <span class="c1"># 1. Apply variable types first (sets factor metadata)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_variable_types</span><span class="p">(</span><span class="n">_parser</span><span class="p">)</span>

        <span class="c1"># 2. Apply factor level definitions (may set additional factor types)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_factor_levels</span><span class="p">()</span>

        <span class="c1"># 3. Expand factors into dummy variables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">factor_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">expand_factors</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expanded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">factor_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> factors&quot;</span><span class="p">)</span>

        <span class="c1"># 4. Apply cluster configurations (needs expanded factor names)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_clusters</span><span class="p">()</span>

        <span class="c1"># 5. Apply uploaded data (overrides variable types for matched columns)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_data</span><span class="p">()</span>

        <span class="c1"># 6. Apply effects (needs expanded factor names + cluster effects)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_effects</span><span class="p">(</span><span class="n">_parser</span><span class="p">)</span>

        <span class="c1"># 7. Apply correlations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_correlations</span><span class="p">(</span><span class="n">_parser</span><span class="p">)</span>

        <span class="c1"># 8. Validate model is ready</span>
        <span class="n">model_result</span> <span class="o">=</span> <span class="n">_validate_model_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">model_result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="c1"># Invalidate the effect plan cache — apply() rebuilds the variable</span>
        <span class="c1"># registry state, so any cached column mappings are now stale.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_effect_plan_cache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Clear pending state to prevent double-application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_variable_types</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_factor_levels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_effects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_correlations</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model settings applied successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_variable_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_parser</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply pending variable types and expand factor variables into dummies.&quot;&quot;&quot;</span>
        <span class="c1"># Set defaults for all predictors</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">predictor_names</span><span class="p">:</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_predictor</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pred</span> <span class="ow">and</span> <span class="n">pred</span><span class="o">.</span><span class="n">var_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pred</span><span class="o">.</span><span class="n">var_type</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_variable_types</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_variable_types</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">available_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">predictor_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">is_dummy_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
        <span class="n">parsed_vars</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">_parser</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_variable_types</span><span class="p">,</span> <span class="s2">&quot;variable_type&quot;</span><span class="p">,</span> <span class="n">available_vars</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error setting variable types:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">))</span>

        <span class="n">successful</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_data</span> <span class="ow">in</span> <span class="n">parsed_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">var_type</span> <span class="o">=</span> <span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">var_type</span> <span class="o">==</span> <span class="s2">&quot;factor&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_variable_type</span><span class="p">(</span>
                    <span class="n">var_name</span><span class="p">,</span>
                    <span class="n">var_type</span><span class="p">,</span>
                    <span class="n">n_levels</span><span class="o">=</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;n_levels&quot;</span><span class="p">],</span>
                    <span class="n">proportions</span><span class="o">=</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;proportions&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">successful</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">=(factor,</span><span class="si">{</span><span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;n_levels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> levels)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_variable_type</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">var_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;proportion&quot;</span> <span class="ow">in</span> <span class="n">var_data</span><span class="p">:</span>
                    <span class="n">successful</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">=(</span><span class="si">{</span><span class="n">var_type</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;proportion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">successful</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">var_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">successful</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable types: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">successful</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_factor_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply pending factor level definitions to the registry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_factor_levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_factor_levels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid format &#39;</span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">&#39;. Expected &#39;var=level1,level2,...&#39;&quot;</span><span class="p">)</span>
            <span class="n">var_name</span><span class="p">,</span> <span class="n">levels_str</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">level</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Factor &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; must have at least 2 levels, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_predictors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in model predictors&quot;</span><span class="p">)</span>

            <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
            <span class="n">proportions</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">n_levels</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_levels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_variable_type</span><span class="p">(</span>
                <span class="n">var_name</span><span class="p">,</span>
                <span class="s2">&quot;factor&quot;</span><span class="p">,</span>
                <span class="n">n_levels</span><span class="o">=</span><span class="n">n_levels</span><span class="p">,</span>
                <span class="n">proportions</span><span class="o">=</span><span class="n">proportions</span><span class="p">,</span>
                <span class="n">level_labels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                <span class="n">reference_level</span><span class="o">=</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_factor_levels</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register pending cluster specifications in the variable registry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Validate that all parsed random effects have cluster config</span>
        <span class="n">parsed_grouping_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">[</span><span class="s2">&quot;grouping_var&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_random_effects_parsed</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">gv</span> <span class="ow">in</span> <span class="n">parsed_grouping_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Random effect (1|</span><span class="si">{</span><span class="n">gv</span><span class="si">}</span><span class="s2">) found in formula but set_cluster(&#39;</span><span class="si">{</span><span class="n">gv</span><span class="si">}</span><span class="s2">&#39;, ...) &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;not called. You must configure all random effects.&quot;</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">gv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parsed_grouping_vars</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_cluster(&#39;</span><span class="si">{</span><span class="n">gv</span><span class="si">}</span><span class="s2">&#39;, ...) called but (1|</span><span class="si">{</span><span class="n">gv</span><span class="si">}</span><span class="s2">) not found in formula.&quot;</span><span class="p">)</span>

        <span class="c1"># Register clusters in order: parents first, then children (nested)</span>
        <span class="c1"># This ensures parent specs exist before child specs reference them</span>
        <span class="n">parent_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">gv</span> <span class="k">for</span> <span class="n">gv</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_var&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">child_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">gv</span> <span class="k">for</span> <span class="n">gv</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_var&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">grouping_var</span> <span class="ow">in</span> <span class="n">parent_vars</span> <span class="o">+</span> <span class="n">child_vars</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span>
            <span class="c1"># Warn if ICC=0</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;icc&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: ICC=0 for &#39;</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;. No random variation between clusters.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">register_cluster</span><span class="p">(</span>
                <span class="n">grouping_var</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
                <span class="n">n_clusters</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;n_clusters&quot;</span><span class="p">],</span>
                <span class="n">cluster_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cluster_size&quot;</span><span class="p">],</span>
                <span class="n">icc</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;icc&quot;</span><span class="p">],</span>
                <span class="n">random_slopes</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;random_slopes&quot;</span><span class="p">),</span>
                <span class="n">slope_variance</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;slope_variance&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="n">slope_intercept_corr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;slope_intercept_corr&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="n">parent_var</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_var&quot;</span><span class="p">),</span>
                <span class="n">n_per_parent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_per_parent&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster variables configured: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply uploaded empirical data, auto-detecting types and routing to the appropriate mode.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span>
        <span class="n">preserve_correlation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span><span class="p">[</span><span class="s2">&quot;preserve_correlation&quot;</span><span class="p">]</span>
        <span class="n">data_types_override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span><span class="p">[</span><span class="s2">&quot;data_types&quot;</span><span class="p">]</span>

        <span class="c1"># Store sample count for warnings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_data_n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preserve_correlation</span> <span class="o">=</span> <span class="n">preserve_correlation</span>

        <span class="c1"># Get all predictor variables (both factor and non-factor)</span>
        <span class="n">all_predictor_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">predictor_names</span>
        <span class="n">matched_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matched_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unmatched</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_predictor_vars</span><span class="p">:</span>
                <span class="n">matched_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">matched_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unmatched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No data columns match model variables — uploaded data ignored.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">unmatched</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Ignoring unmatched columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unmatched</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Extract matched data</span>
        <span class="n">matched_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">matched_indices</span><span class="p">]</span>

        <span class="c1"># Reject NaN values early</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">matched_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">nan_cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">matched_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">matched_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">matched_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="p">]</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Uploaded data contains NaN values in columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nan_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Remove or impute missing values before uploading.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="c1"># Object dtype columns (strings) can&#39;t be converted to float for NaN check.</span>
            <span class="c1"># NaN check for numeric columns will happen after string encoding below.</span>
            <span class="k">pass</span>

        <span class="c1"># Convert to float64 if object dtype (common with mixed-type DataFrames)</span>
        <span class="c1"># String columns are encoded to integer indices; mapping is stored in string_col_indices</span>
        <span class="n">string_col_indices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">matched_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">matched_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">matched_columns</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">matched_data</span><span class="p">[:,</span> <span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_data</span><span class="p">[:,</span> <span class="n">ci</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="c1"># String column — encode to sorted integer indices, store mapping</span>
                    <span class="n">raw_strings</span> <span class="o">=</span> <span class="n">matched_data</span><span class="p">[:,</span> <span class="n">ci</span><span class="p">]</span>
                    <span class="n">unique_strings</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_strings</span><span class="p">})</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_strings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_strings</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique string values — &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;too many unique values for a factor. Use data_types to override.&quot;</span>
                        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
                    <span class="n">label_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_strings</span><span class="p">)}</span>
                    <span class="n">encoded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">label_map</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_strings</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="n">matched_data</span><span class="p">[:,</span> <span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoded</span>
                    <span class="n">string_col_indices</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">unique_strings</span><span class="p">,</span>
                        <span class="s2">&quot;label_map&quot;</span><span class="p">:</span> <span class="n">label_map</span><span class="p">,</span>
                    <span class="p">}</span>
            <span class="n">matched_data</span> <span class="o">=</span> <span class="n">matched_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># Auto-detect variable types based on unique values</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Auto-detecting variable types ===&quot;</span><span class="p">)</span>
        <span class="n">auto_detected_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dropped_columns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">preserve_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preserve_factor_level_names&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matched_columns</span><span class="p">):</span>
            <span class="n">col_data</span> <span class="o">=</span> <span class="n">matched_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">unique_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">col_data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">col_data</span><span class="p">)])</span>
            <span class="n">n_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">)</span>

            <span class="c1"># Determine level_labels</span>
            <span class="n">level_labels</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">string_col_indices</span><span class="p">:</span>
                <span class="c1"># String column — use the sorted string labels</span>
                <span class="k">if</span> <span class="n">preserve_labels</span><span class="p">:</span>
                    <span class="n">level_labels</span> <span class="o">=</span> <span class="n">string_col_indices</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
                <span class="c1"># String columns always auto-detect as factor (unless overridden)</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_types_override</span><span class="p">:</span>
                    <span class="n">detected_type</span> <span class="o">=</span> <span class="n">data_types_override</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">detected_type</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">detected_type</span> <span class="o">=</span> <span class="n">detected_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values -&gt; </span><span class="si">{</span><span class="n">detected_type</span><span class="si">}</span><span class="s2"> (overridden)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">detected_type</span> <span class="o">=</span> <span class="s2">&quot;factor&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique string values -&gt; factor&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Numeric column — existing detection logic</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_types_override</span><span class="p">:</span>
                    <span class="n">detected_type</span> <span class="o">=</span> <span class="n">data_types_override</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">detected_type</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">detected_type</span> <span class="o">=</span> <span class="n">detected_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values -&gt; </span><span class="si">{</span><span class="n">detected_type</span><span class="si">}</span><span class="s2"> (overridden)&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">n_unique</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique value -&gt; DROPPED (constant)&quot;</span><span class="p">)</span>
                    <span class="n">dropped_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">n_unique</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">detected_type</span> <span class="o">=</span> <span class="s2">&quot;binary&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values -&gt; binary&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="n">n_unique</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">detected_type</span> <span class="o">=</span> <span class="s2">&quot;factor&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values -&gt; factor&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># n_unique &gt;= 7</span>
                    <span class="n">detected_type</span> <span class="o">=</span> <span class="s2">&quot;continuous&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values -&gt; continuous&quot;</span><span class="p">)</span>

                <span class="c1"># Compute level labels for factors from numeric values</span>
                <span class="k">if</span> <span class="n">preserve_labels</span> <span class="ow">and</span> <span class="n">detected_type</span> <span class="o">==</span> <span class="s2">&quot;factor&quot;</span><span class="p">:</span>
                    <span class="n">sorted_vals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">)</span>
                    <span class="n">level_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sorted_vals</span><span class="p">]</span>

            <span class="n">auto_detected_types</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">detected_type</span><span class="p">,</span>
                <span class="s2">&quot;unique_count&quot;</span><span class="p">:</span> <span class="n">n_unique</span><span class="p">,</span>
                <span class="s2">&quot;unique_values&quot;</span><span class="p">:</span> <span class="n">unique_vals</span><span class="p">,</span>
                <span class="s2">&quot;data_index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s2">&quot;level_labels&quot;</span><span class="p">:</span> <span class="n">level_labels</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Remove dropped columns</span>
        <span class="k">if</span> <span class="n">dropped_columns</span><span class="p">:</span>
            <span class="n">matched_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">matched_columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dropped_columns</span><span class="p">]</span>
            <span class="n">matched_data</span> <span class="o">=</span> <span class="n">matched_data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">auto_detected_types</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;data_index&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">matched_columns</span><span class="p">]]</span>
            <span class="c1"># Reindex</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matched_columns</span><span class="p">):</span>
                <span class="n">auto_detected_types</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;data_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All uploaded columns were dropped (constant values)&quot;</span><span class="p">)</span>

        <span class="c1"># Validate reference levels from data_types tuples</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">data_types_override</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ref_val</span> <span class="o">=</span> <span class="n">dt</span>
                <span class="n">ref_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">auto_detected_types</span><span class="p">:</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="n">auto_detected_types</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level_labels&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">labels</span> <span class="ow">and</span> <span class="n">ref_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference level &#39;</span><span class="si">{</span><span class="n">ref_val</span><span class="si">}</span><span class="s2">&#39; not found in unique values for column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;. Available: </span><span class="si">{</span><span class="n">labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Process based on mode</span>
        <span class="k">if</span> <span class="n">preserve_correlation</span> <span class="o">==</span> <span class="s2">&quot;strict&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_data_strict_mode</span><span class="p">(</span><span class="n">matched_data</span><span class="p">,</span> <span class="n">matched_columns</span><span class="p">,</span> <span class="n">auto_detected_types</span><span class="p">,</span> <span class="n">data_types_override</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &#39;no&#39; or &#39;partial&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_data_normal_mode</span><span class="p">(</span><span class="n">matched_data</span><span class="p">,</span> <span class="n">matched_columns</span><span class="p">,</span> <span class="n">auto_detected_types</span><span class="p">,</span> <span class="n">preserve_correlation</span><span class="p">,</span> <span class="n">data_types_override</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Uploaded data: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matched_columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation preservation mode: </span><span class="si">{</span><span class="n">preserve_correlation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_data_normal_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">type_info</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">data_types_override</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply uploaded data in &#39;no&#39; or &#39;partial&#39; mode using quantile-matched lookup tables.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.stats.data_generation</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_uploaded_lookup_tables</span>

        <span class="k">if</span> <span class="n">data_types_override</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_types_override</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Process each variable based on detected type</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">type_info</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">col_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;data_index&quot;</span><span class="p">]]</span>
            <span class="n">detected_type</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">detected_type</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
                <span class="c1"># Convert to standard binary (type 1)</span>
                <span class="c1"># Detect proportion (which value is &quot;1&quot;)</span>
                <span class="n">unique_vals</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;unique_values&quot;</span><span class="p">]</span>
                <span class="c1"># Use the more frequent value as 0, less frequent as 1</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">col_data</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">unique_vals</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="c1"># First value is less frequent -&gt; it&#39;s &quot;1&quot;</span>
                    <span class="n">proportion</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Second value is less frequent -&gt; it&#39;s &quot;1&quot;</span>
                    <span class="n">proportion</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_data</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_variable_type</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="n">proportion</span><span class="o">=</span><span class="n">proportion</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">detected_type</span> <span class="o">==</span> <span class="s2">&quot;factor&quot;</span><span class="p">:</span>
                <span class="c1"># Convert to existing factor system</span>
                <span class="n">unique_vals</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;unique_values&quot;</span><span class="p">]</span>
                <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">)</span>
                <span class="n">level_labels</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level_labels&quot;</span><span class="p">)</span>

                <span class="c1"># Determine reference from data_types tuple override</span>
                <span class="n">reference_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_reference_level</span><span class="p">(</span><span class="n">data_types_override</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

                <span class="c1"># Calculate proportions for each level</span>
                <span class="n">proportions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">unique_vals</span><span class="p">:</span>
                    <span class="n">prop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">col_data</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_data</span><span class="p">)</span>
                    <span class="n">proportions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_levels&quot;</span><span class="p">:</span> <span class="n">n_levels</span><span class="p">,</span> <span class="s2">&quot;proportions&quot;</span><span class="p">:</span> <span class="n">proportions</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">level_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;level_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_labels</span>
                <span class="k">if</span> <span class="n">reference_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;reference_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_level</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_variable_type</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;factor&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># continuous</span>
                <span class="c1"># Normalize: mean=0, sd=1</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">col_data</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">std</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; has zero variance (constant value). Remove it from the model or check your data.&quot;</span><span class="p">)</span>
                <span class="n">normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">col_data</span><span class="p">))</span> <span class="o">/</span> <span class="n">std</span>

                <span class="c1"># Create lookup tables (type 99)</span>
                <span class="n">normal_vals</span><span class="p">,</span> <span class="n">uploaded_vals</span> <span class="o">=</span> <span class="n">create_uploaded_lookup_tables</span><span class="p">(</span><span class="n">normalized</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="c1"># Store in lookup tables</span>
                <span class="n">non_factor_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">non_factor_names</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">non_factor_vars</span><span class="p">:</span>
                    <span class="n">var_idx</span> <span class="o">=</span> <span class="n">non_factor_vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_factor_vars</span><span class="p">)</span>

                    <span class="c1"># Resize if needed</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_normal_values</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_normal_values</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_vars</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_data</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">upload_normal_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_vars</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_data</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">upload_data_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_vars</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_data</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_normal_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_data_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">upload_normal_values</span><span class="p">[</span><span class="n">var_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">normal_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">upload_data_values</span><span class="p">[</span><span class="n">var_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">uploaded_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Set variable type to uploaded_data</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_predictor</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pred</span><span class="p">:</span>
                        <span class="n">pred</span><span class="o">.</span><span class="n">var_type</span> <span class="o">=</span> <span class="s2">&quot;uploaded_data&quot;</span>

        <span class="c1"># Expand factors if any were detected</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">factor_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">expand_factors</span><span class="p">()</span>

        <span class="c1"># Mode &#39;partial&#39;: compute correlation matrix from continuous uploaded data</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;partial&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_data_correlations</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">type_info</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
            <span class="c1"># Ensure correlation matrix is initialized to identity</span>
            <span class="n">non_factor_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">non_factor_names</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_factor_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">existing_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_correlation_matrix</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">existing_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_factor_vars</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_correlation_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_vars</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_data_correlations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">type_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute and merge a correlation matrix from uploaded continuous variables.&quot;&quot;&quot;</span>
        <span class="c1"># Get continuous uploaded variables</span>
        <span class="n">continuous_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">type_info</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">continuous_cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># No correlations to compute</span>

        <span class="c1"># Extract continuous data</span>
        <span class="n">continuous_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">type_info</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;data_index&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">continuous_cols</span><span class="p">]</span>
        <span class="n">continuous_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">continuous_indices</span><span class="p">]</span>

        <span class="c1"># Compute correlation matrix</span>
        <span class="n">data_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">continuous_data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Merge with existing correlation matrix</span>
        <span class="n">non_factor_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">non_factor_names</span>
        <span class="n">existing_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_correlation_matrix</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">existing_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create identity matrix</span>
            <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_factor_vars</span><span class="p">)</span>
            <span class="n">existing_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)</span>

        <span class="c1"># Fill in correlations between uploaded continuous variables</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">continuous_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">col1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">non_factor_vars</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="n">non_factor_vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">col2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">continuous_cols</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">col2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">non_factor_vars</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">idx2</span> <span class="o">=</span> <span class="n">non_factor_vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col2</span><span class="p">)</span>

                <span class="c1"># Only update if not user-specified (user override)</span>
                <span class="c1"># For now, always update from data</span>
                <span class="n">existing_corr</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_corr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">existing_corr</span><span class="p">[</span><span class="n">idx2</span><span class="p">,</span> <span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_corr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_correlation_matrix</span><span class="p">(</span><span class="n">existing_corr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computed correlations from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">continuous_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> continuous variables&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_data_strict_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">type_info</span><span class="p">,</span> <span class="n">data_types_override</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply uploaded data in &#39;strict&#39; mode, storing normalised rows for bootstrapping.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_types_override</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_types_override</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Store raw data for bootstrap</span>
        <span class="c1"># Normalize continuous variables</span>
        <span class="n">normalized_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">binary_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">factor_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">continuous_cols</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">type_info</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;data_index&quot;</span><span class="p">]</span>
            <span class="n">detected_type</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">detected_type</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
                <span class="n">binary_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="c1"># Store mapping info</span>
                <span class="n">unique_vals</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;unique_values&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_var_metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;unique_values&quot;</span><span class="p">:</span> <span class="n">unique_vals</span><span class="p">,</span>
                    <span class="s2">&quot;data_index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="c1"># Mark as uploaded_binary (type 98)</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_predictor</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pred</span><span class="p">:</span>
                    <span class="n">pred</span><span class="o">.</span><span class="n">var_type</span> <span class="o">=</span> <span class="s2">&quot;uploaded_binary&quot;</span>

            <span class="k">elif</span> <span class="n">detected_type</span> <span class="o">==</span> <span class="s2">&quot;factor&quot;</span><span class="p">:</span>
                <span class="n">factor_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">unique_vals</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;unique_values&quot;</span><span class="p">]</span>
                <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">)</span>
                <span class="n">level_labels</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level_labels&quot;</span><span class="p">)</span>

                <span class="c1"># Determine reference from data_types tuple override</span>
                <span class="n">reference_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_reference_level</span><span class="p">(</span><span class="n">data_types_override</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_var_metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;factor&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;unique_values&quot;</span><span class="p">:</span> <span class="n">unique_vals</span><span class="p">,</span>
                    <span class="s2">&quot;n_levels&quot;</span><span class="p">:</span> <span class="n">n_levels</span><span class="p">,</span>
                    <span class="s2">&quot;data_index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
                    <span class="s2">&quot;level_labels&quot;</span><span class="p">:</span> <span class="n">level_labels</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># Register as factor but mark for bootstrap</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_levels&quot;</span><span class="p">:</span> <span class="n">n_levels</span><span class="p">,</span> <span class="s2">&quot;proportions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n_levels</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_levels</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">level_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;level_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_labels</span>
                <span class="k">if</span> <span class="n">reference_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;reference_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_level</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_variable_type</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;factor&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Mark as uploaded_factor</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_predictor</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pred</span><span class="p">:</span>
                    <span class="n">pred</span><span class="o">.</span><span class="n">var_type</span> <span class="o">=</span> <span class="s2">&quot;uploaded_factor&quot;</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># continuous</span>
                <span class="n">continuous_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="c1"># Normalize</span>
                <span class="n">col_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">col_data</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">std</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; has zero variance (constant value). Remove it from the model or check your data.&quot;</span><span class="p">)</span>
                <span class="n">normalized_data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">col_data</span><span class="p">))</span> <span class="o">/</span> <span class="n">std</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_var_metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;continuous&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;data_index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="c1"># Mark as uploaded continuous (but this goes through non-factor pipeline)</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_predictor</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pred</span><span class="p">:</span>
                    <span class="n">pred</span><span class="o">.</span><span class="n">var_type</span> <span class="o">=</span> <span class="s2">&quot;uploaded_data&quot;</span>  <span class="c1"># Will be handled by bootstrap</span>

        <span class="c1"># Expand factors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">factor_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">expand_factors</span><span class="p">()</span>

        <span class="c1"># Store normalized data for bootstrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_raw_data</span> <span class="o">=</span> <span class="n">normalized_data</span>

        <span class="c1"># Warn about cross-correlations</span>
        <span class="n">non_factor_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">non_factor_names</span>
        <span class="n">uploaded_non_factor</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">non_factor_vars</span><span class="p">]</span>
        <span class="n">created_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">non_factor_vars</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uploaded_non_factor</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">created_vars</span> <span class="ow">and</span> <span class="n">uploaded_non_factor</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: Cross-correlations between uploaded (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uploaded_non_factor</span><span class="p">)</span><span class="si">}</span><span class="s2">) &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;and created (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">created_vars</span><span class="p">)</span><span class="si">}</span><span class="s2">) variables will be set to zero.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Zero out cross-correlations in correlation matrix</span>
            <span class="n">existing_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_correlation_matrix</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">existing_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_factor_vars</span><span class="p">)</span>
                <span class="n">existing_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">up_var</span> <span class="ow">in</span> <span class="n">uploaded_non_factor</span><span class="p">:</span>
                <span class="n">up_idx</span> <span class="o">=</span> <span class="n">non_factor_vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">up_var</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cr_var</span> <span class="ow">in</span> <span class="n">created_vars</span><span class="p">:</span>
                    <span class="n">cr_idx</span> <span class="o">=</span> <span class="n">non_factor_vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cr_var</span><span class="p">)</span>
                    <span class="n">existing_corr</span><span class="p">[</span><span class="n">up_idx</span><span class="p">,</span> <span class="n">cr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">existing_corr</span><span class="p">[</span><span class="n">cr_idx</span><span class="p">,</span> <span class="n">up_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_correlation_matrix</span><span class="p">(</span><span class="n">existing_corr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_parser</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse and apply pending effect-size assignments to the registry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_effects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">assignments</span> <span class="o">=</span> <span class="n">_parser</span><span class="o">.</span><span class="n">_split_assignments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_effects</span><span class="p">)</span>
        <span class="n">effect_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">effect_names</span>

        <span class="n">successful</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assignment</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid format &#39;</span><span class="si">{</span><span class="n">assignment</span><span class="si">}</span><span class="s2">&#39;. Expected: &#39;name=value&#39;&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">name</span><span class="p">,</span> <span class="n">value_str</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value_str</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">value_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid value &#39;</span><span class="si">{</span><span class="n">value_str</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">effect_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_effect_size</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">successful</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found. Available: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">effect_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Effect validation failed:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">successful</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effects: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">successful</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_correlations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_parser</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse and apply pending correlation settings to the registry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_correlations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Correlations only apply to non-factor variables (not dummies)</span>
        <span class="n">non_factor_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">non_factor_names</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_factor_vars</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least 2 non-factor variables for correlations&quot;</span><span class="p">)</span>

        <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_factor_vars</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_correlation_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_vars</span><span class="p">))</span>

        <span class="n">correlations_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_correlations</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">correlations_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">correlations_input</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="n">correlations</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">_parser</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">correlations_input</span><span class="p">,</span> <span class="s2">&quot;correlation&quot;</span><span class="p">,</span> <span class="n">non_factor_vars</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error setting correlations:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">))</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">correlations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_correlation</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">correlation_matrix</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid correlation matrix:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span><span class="si">}</span><span class="s2"> set&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">correlations_input</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">correlations_input</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_vars</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matrix shape </span><span class="si">{</span><span class="n">correlations_input</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> doesn&#39;t match </span><span class="si">{</span><span class="n">n_vars</span><span class="si">}</span><span class="s2"> non-factor variables&quot;</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_correlation_matrix</span><span class="p">(</span><span class="n">correlations_input</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid correlation matrix:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">set_correlation_matrix</span><span class="p">(</span><span class="n">correlations_input</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation matrix set&quot;</span><span class="p">)</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># Analysis methods</span>
    <span class="c1"># =========================================================================</span>

<div class="viewcode-block" id="MCPower.find_power">
<a class="viewcode-back" href="../../api/power-analysis.html#mcpower.MCPower.find_power">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_power</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">target_test</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">correction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">print_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">scenarios</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;short&quot;</span><span class="p">,</span>
        <span class="n">return_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">test_formula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cancel_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate statistical power for given sample size.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_size: Number of observations per simulation</span>
<span class="sd">            target_test: Effect(s) to test. ``&quot;all&quot;`` (default) runs overall</span>
<span class="sd">                F-test + all individual fixed effects. Also accepts</span>
<span class="sd">                ``&quot;all-posthoc&quot;``, specific names like ``&quot;x1&quot;``,</span>
<span class="sd">                pairwise comparisons like ``&quot;factor[a] vs factor[b]&quot;``,</span>
<span class="sd">                exclusions like ``&quot;-test_name&quot;``, or comma-separated</span>
<span class="sd">                combinations. Duplicate tests raise ``ValueError``.</span>
<span class="sd">            correction: Multiple comparison correction (None, &quot;bonferroni&quot;, &quot;benjamini-hochberg&quot;, &quot;holm&quot;)</span>
<span class="sd">            print_results: Whether to print results</span>
<span class="sd">            scenarios: Scenario analysis control — ``False`` (default) disables</span>
<span class="sd">                scenario analysis, ``True`` runs all configured scenarios,</span>
<span class="sd">                or pass a list of scenario names to run selectively</span>
<span class="sd">                (e.g. ``[&quot;optimistic&quot;, &quot;extreme&quot;]``). Case-insensitive.</span>
<span class="sd">            summary: Output detail level (&quot;short&quot; or &quot;long&quot;)</span>
<span class="sd">            return_results: Return results dict</span>
<span class="sd">            test_formula: Formula for statistical testing (default: use data</span>
<span class="sd">                generation formula). If the formula contains random effects</span>
<span class="sd">                like ``(1|school)``, analysis switches to mixed model testing.</span>
<span class="sd">            progress_callback: Progress reporting control — ``None`` (default)</span>
<span class="sd">                auto-uses ``PrintReporter`` when *print_results* is ``True``,</span>
<span class="sd">                ``False`` explicitly disables progress, or pass a callable</span>
<span class="sd">                ``(current, total)`` for custom reporting.</span>
<span class="sd">            cancel_check: Optional callable returning ``True`` to abort.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict or None: If *return_results* is ``True``, returns a</span>
<span class="sd">            results dictionary with keys ``&quot;model&quot;`` (metadata) and</span>
<span class="sd">            ``&quot;results&quot;`` (power estimates). Returns ``None`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Auto-apply if settings have changed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">()</span>

        <span class="c1"># Resolve scenarios parameter</span>
        <span class="n">scenario_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_scenarios</span><span class="p">(</span><span class="n">scenarios</span><span class="p">)</span>

        <span class="c1"># Validate sample size (basic: &gt;= 20, type check)</span>
        <span class="n">_validate_sample_size</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="c1"># Validate sample size against model complexity (&gt;= 15 + n_variables)</span>
        <span class="n">n_variables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">effect_names</span><span class="p">)</span>
        <span class="n">_validate_sample_size_for_model</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">n_variables</span><span class="p">)</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="c1"># Warn if sample size is much larger than uploaded data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_data_n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sample_size</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_data_n</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: Requested sample size (</span><span class="si">{</span><span class="n">sample_size</span><span class="si">}</span><span class="s2">) is more than 3x &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the uploaded data size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_data_n</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;This may lead to unrealistic extrapolation from the empirical distribution.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_analysis_inputs</span><span class="p">(</span><span class="n">correction</span><span class="p">)</span>
        <span class="n">resolved_test_formula</span><span class="p">,</span> <span class="n">test_formula_effects</span><span class="p">,</span> <span class="n">test_random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_test_formula</span><span class="p">(</span><span class="n">test_formula</span><span class="p">)</span>
        <span class="n">target_tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_target_tests</span><span class="p">(</span><span class="n">target_test</span><span class="p">,</span> <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_tukey_posthoc</span><span class="p">(</span><span class="n">correction</span><span class="p">)</span>

        <span class="n">reporter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_progress</span><span class="p">(</span><span class="n">progress_callback</span><span class="p">,</span> <span class="n">print_results</span><span class="p">,</span> <span class="n">scenario_filter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scenario_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_scenario_analysis</span><span class="p">(</span>
                <span class="s2">&quot;power&quot;</span><span class="p">,</span>
                <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
                <span class="n">target_tests</span><span class="o">=</span><span class="n">target_tests</span><span class="p">,</span>
                <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
                <span class="n">print_results</span><span class="o">=</span><span class="n">print_results</span><span class="p">,</span>
                <span class="n">test_formula</span><span class="o">=</span><span class="n">resolved_test_formula</span><span class="p">,</span>
                <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">,</span>
                <span class="n">test_random_effects</span><span class="o">=</span><span class="n">test_random_effects</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">reporter</span><span class="p">,</span>
                <span class="n">cancel_check</span><span class="o">=</span><span class="n">cancel_check</span><span class="p">,</span>
                <span class="n">scenario_filter</span><span class="o">=</span><span class="n">scenario_filter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reporter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_find_power</span><span class="p">(</span>
                <span class="n">sample_size</span><span class="p">,</span>
                <span class="n">target_tests</span><span class="p">,</span>
                <span class="n">correction</span><span class="p">,</span>
                <span class="n">scenario_config</span><span class="o">=</span><span class="n">DEFAULT_SCENARIO_CONFIG</span><span class="p">[</span><span class="s2">&quot;optimistic&quot;</span><span class="p">],</span>
                <span class="n">test_formula</span><span class="o">=</span><span class="n">resolved_test_formula</span><span class="p">,</span>
                <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">,</span>
                <span class="n">test_random_effects</span><span class="o">=</span><span class="n">test_random_effects</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">reporter</span><span class="p">,</span>
                <span class="n">cancel_check</span><span class="o">=</span><span class="n">cancel_check</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scenario_filter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">print_results</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">80</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MONTE CARLO POWER ANALYSIS RESULTS&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">80</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">correction</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple comparison correction: </span><span class="si">{</span><span class="n">correction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">_format_results</span><span class="p">(</span><span class="s2">&quot;power&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">summary</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="n">return_results</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MCPower.find_sample_size">
<a class="viewcode-back" href="../../api/power-analysis.html#mcpower.MCPower.find_sample_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_sample_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target_test</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">from_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">to_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">by</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">correction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">print_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">scenarios</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;short&quot;</span><span class="p">,</span>
        <span class="n">return_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">test_formula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cancel_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find minimum sample size needed for target power.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_test: Effect(s) to test. Defaults to ``&quot;all&quot;``.</span>
<span class="sd">                See :meth:`find_power` for full keyword/exclusion syntax.</span>
<span class="sd">            from_size: Minimum sample size to test</span>
<span class="sd">            to_size: Maximum sample size to test</span>
<span class="sd">            by: Step size between sample sizes</span>
<span class="sd">            correction: Multiple comparison correction</span>
<span class="sd">            print_results: Whether to print results</span>
<span class="sd">            scenarios: Scenario analysis control — ``False`` (default) disables</span>
<span class="sd">                scenario analysis, ``True`` runs all configured scenarios,</span>
<span class="sd">                or pass a list of scenario names to run selectively</span>
<span class="sd">                (e.g. ``[&quot;optimistic&quot;, &quot;extreme&quot;]``). Case-insensitive.</span>
<span class="sd">            summary: Output detail level</span>
<span class="sd">            return_results: Return results dict</span>
<span class="sd">            test_formula: Formula for statistical testing (default: use data</span>
<span class="sd">                generation formula). If the formula contains random effects</span>
<span class="sd">                like ``(1|school)``, analysis switches to mixed model testing.</span>
<span class="sd">            progress_callback: Progress reporting control — ``None`` (default)</span>
<span class="sd">                auto-uses ``PrintReporter`` when *print_results* is ``True``,</span>
<span class="sd">                ``False`` explicitly disables progress, or pass a callable</span>
<span class="sd">                ``(current, total)`` for custom reporting.</span>
<span class="sd">            cancel_check: Optional callable returning ``True`` to abort.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict or None: If *return_results* is ``True``, returns a</span>
<span class="sd">            results dictionary with keys ``&quot;model&quot;`` (metadata) and</span>
<span class="sd">            ``&quot;results&quot;`` (per-sample-size power estimates, first-achieved</span>
<span class="sd">            sizes). Returns ``None`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Auto-apply if settings have changed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applied</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">()</span>

        <span class="c1"># Resolve scenarios parameter</span>
        <span class="n">scenario_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_scenarios</span><span class="p">(</span><span class="n">scenarios</span><span class="p">)</span>

        <span class="c1"># Validate from_size meets minimum requirements</span>
        <span class="n">_validate_sample_size</span><span class="p">(</span><span class="n">from_size</span><span class="p">)</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>
        <span class="n">n_variables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">effect_names</span><span class="p">)</span>
        <span class="n">_validate_sample_size_for_model</span><span class="p">(</span><span class="n">from_size</span><span class="p">,</span> <span class="n">n_variables</span><span class="p">)</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="c1"># Warn if max sample size is much larger than uploaded data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_data_n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">to_size</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_data_n</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: Maximum sample size (</span><span class="si">{</span><span class="n">to_size</span><span class="si">}</span><span class="s2">) is more than 3x &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the uploaded data size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_uploaded_data_n</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;This may lead to oversimplistic extrapolation from the empirical distribution.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_analysis_inputs</span><span class="p">(</span><span class="n">correction</span><span class="p">)</span>
        <span class="n">resolved_test_formula</span><span class="p">,</span> <span class="n">test_formula_effects</span><span class="p">,</span> <span class="n">test_random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_test_formula</span><span class="p">(</span><span class="n">test_formula</span><span class="p">)</span>
        <span class="n">validation_result</span> <span class="o">=</span> <span class="n">_validate_sample_size_range</span><span class="p">(</span><span class="n">from_size</span><span class="p">,</span> <span class="n">to_size</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">warning</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">validation_result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="n">target_tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_target_tests</span><span class="p">(</span><span class="n">target_test</span><span class="p">,</span> <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_tukey_posthoc</span><span class="p">(</span><span class="n">correction</span><span class="p">)</span>

        <span class="n">sample_sizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">from_size</span><span class="p">,</span> <span class="n">to_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">by</span><span class="p">))</span>

        <span class="n">reporter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_progress</span><span class="p">(</span><span class="n">progress_callback</span><span class="p">,</span> <span class="n">print_results</span><span class="p">,</span> <span class="n">scenario_filter</span><span class="p">,</span> <span class="n">n_sample_sizes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">scenario_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_scenario_analysis</span><span class="p">(</span>
                <span class="s2">&quot;sample_size&quot;</span><span class="p">,</span>
                <span class="n">target_tests</span><span class="o">=</span><span class="n">target_tests</span><span class="p">,</span>
                <span class="n">sample_sizes</span><span class="o">=</span><span class="n">sample_sizes</span><span class="p">,</span>
                <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
                <span class="n">print_results</span><span class="o">=</span><span class="n">print_results</span><span class="p">,</span>
                <span class="n">test_formula</span><span class="o">=</span><span class="n">resolved_test_formula</span><span class="p">,</span>
                <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">,</span>
                <span class="n">test_random_effects</span><span class="o">=</span><span class="n">test_random_effects</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">reporter</span><span class="p">,</span>
                <span class="n">cancel_check</span><span class="o">=</span><span class="n">cancel_check</span><span class="p">,</span>
                <span class="n">scenario_filter</span><span class="o">=</span><span class="n">scenario_filter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reporter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_sample_size_analysis</span><span class="p">(</span>
                <span class="n">sample_sizes</span><span class="p">,</span>
                <span class="n">target_tests</span><span class="p">,</span>
                <span class="n">correction</span><span class="p">,</span>
                <span class="n">scenario_config</span><span class="o">=</span><span class="n">DEFAULT_SCENARIO_CONFIG</span><span class="p">[</span><span class="s2">&quot;optimistic&quot;</span><span class="p">],</span>
                <span class="n">test_formula</span><span class="o">=</span><span class="n">resolved_test_formula</span><span class="p">,</span>
                <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">,</span>
                <span class="n">test_random_effects</span><span class="o">=</span><span class="n">test_random_effects</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">reporter</span><span class="p">,</span>
                <span class="n">cancel_check</span><span class="o">=</span><span class="n">cancel_check</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scenario_filter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">print_results</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">80</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SAMPLE SIZE ANALYSIS RESULTS&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">80</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">correction</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple comparison correction: </span><span class="si">{</span><span class="n">correction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">_format_results</span><span class="p">(</span><span class="s2">&quot;sample_size&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">summary</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">summary</span> <span class="o">==</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_sample_size_plots</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="n">return_results</span> <span class="k">else</span> <span class="kc">None</span></div>


    <span class="c1"># =========================================================================</span>
    <span class="c1"># Statistical methods (linear regression)</span>
    <span class="c1"># =========================================================================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_dependent_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_expanded</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">effect_sizes_expanded</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">heterogeneity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">heteroskedasticity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">sim_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">residual_dist</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">residual_df</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the dependent variable as y = X @ beta + error via the active backend.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_backend</span><span class="p">()</span><span class="o">.</span><span class="n">generate_y</span><span class="p">(</span>
            <span class="n">X_expanded</span><span class="p">,</span>
            <span class="n">effect_sizes_expanded</span><span class="p">,</span>
            <span class="n">heterogeneity</span><span class="p">,</span>
            <span class="n">heteroskedasticity</span><span class="p">,</span>
            <span class="n">sim_seed</span> <span class="k">if</span> <span class="n">sim_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">residual_dist</span><span class="p">,</span>
            <span class="n">residual_df</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># Internal methods</span>
    <span class="c1"># =========================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_reference_level</span><span class="p">(</span><span class="n">data_types_override</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract reference level from data_types_override tuple for a column.&quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">data_types_override</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve the scenarios parameter into a list of scenario names or None.</span>

<span class="sd">        Args:</span>
<span class="sd">            scenarios: ``False`` for no scenarios, ``True`` for all configured</span>
<span class="sd">                scenarios, or a list of scenario names (case-insensitive).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of validated, lowercase scenario names, or ``None`` if</span>
<span class="sd">            scenarios are disabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any requested scenario name is not configured.</span>
<span class="sd">            TypeError: If *scenarios* is not ``bool`` or a list of strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scenarios</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">all_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario_configs</span> <span class="ow">or</span> <span class="n">DEFAULT_SCENARIO_CONFIG</span>
        <span class="n">available</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_configs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">scenarios</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_configs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scenarios</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scenarios must be True, False, or a list of scenario names, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">scenarios</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Case-insensitive matching</span>
        <span class="n">available_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">available</span><span class="p">}</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scenario names must be strings, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">available_lower</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolved</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">invalid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown scenario(s): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">invalid</span><span class="p">)</span><span class="si">}</span><span class="s2">. Available: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">available</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resolved</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress_callback</span><span class="p">,</span> <span class="n">print_results</span><span class="p">,</span> <span class="n">scenario_filter</span><span class="p">,</span> <span class="n">n_sample_sizes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve progress_callback into a ProgressReporter or None.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.progress</span><span class="w"> </span><span class="kn">import</span> <span class="n">PrintReporter</span><span class="p">,</span> <span class="n">ProgressReporter</span><span class="p">,</span> <span class="n">compute_total_simulations</span>

        <span class="k">if</span> <span class="n">progress_callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">effective_cb</span> <span class="o">=</span> <span class="n">PrintReporter</span><span class="p">()</span> <span class="k">if</span> <span class="n">print_results</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">progress_callback</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">effective_cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">effective_cb</span> <span class="o">=</span> <span class="n">progress_callback</span>

        <span class="k">if</span> <span class="n">effective_cb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">n_scenarios</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scenario_filter</span><span class="p">)</span> <span class="k">if</span> <span class="n">scenario_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">compute_total_simulations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_n_simulations</span><span class="p">,</span> <span class="n">n_sample_sizes</span><span class="p">,</span> <span class="n">n_scenarios</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ProgressReporter</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">effective_cb</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_analysis_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the multiple-comparison correction method before analysis.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_validate_correction_method</span><span class="p">(</span><span class="n">correction</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_tukey_posthoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raise if Tukey correction is requested without posthoc specs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">correction</span> <span class="ow">and</span> <span class="n">correction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tukey&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_posthoc_specs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Tukey correction requires at least one post-hoc comparison &quot;</span>
                <span class="s2">&quot;(e.g., target_test=&#39;group[0] vs group[1]&#39;). &quot;</span>
                <span class="s2">&quot;Tukey HSD only applies to pairwise contrasts between factor levels.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_cluster_sample_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Derive missing cluster dimensions from sample_size and validate minimums.&quot;&quot;&quot;</span>
        <span class="c1"># NOTE: This method both validates AND mutates — it derives missing</span>
        <span class="c1"># cluster_size/n_clusters from sample_size before checking minimums.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># No clusters, nothing to do</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">_validate_cluster_sample_size</span>

        <span class="k">for</span> <span class="n">gv</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_cluster_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Derive the missing dimension from sample_size</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">n_clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">cluster_size</span> <span class="o">=</span> <span class="n">sample_size</span> <span class="o">//</span> <span class="n">spec</span><span class="o">.</span><span class="n">n_clusters</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">cluster_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster &#39;</span><span class="si">{</span><span class="n">gv</span><span class="si">}</span><span class="s2">&#39;: either n_clusters or cluster_size must be set&quot;</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">sample_size</span> <span class="o">//</span> <span class="n">spec</span><span class="o">.</span><span class="n">cluster_size</span>

            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">n_clusters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">cluster_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster &#39;</span><span class="si">{</span><span class="n">gv</span><span class="si">}</span><span class="s2">&#39;: failed to derive n_clusters and cluster_size from sample_size=</span><span class="si">{</span><span class="n">sample_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">actual_n</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">n_clusters</span> <span class="o">*</span> <span class="n">spec</span><span class="o">.</span><span class="n">cluster_size</span>
            <span class="k">if</span> <span class="n">actual_n</span> <span class="o">!=</span> <span class="n">sample_size</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: sample_size </span><span class="si">{</span><span class="n">sample_size</span><span class="si">}</span><span class="s2"> not evenly divisible by &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;n_clusters=</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> for &#39;</span><span class="si">{</span><span class="n">gv</span><span class="si">}</span><span class="s2">&#39;. Using </span><span class="si">{</span><span class="n">actual_n</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(cluster_size=</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">cluster_size</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

            <span class="n">_validate_cluster_sample_size</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">cluster_size</span><span class="p">)</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_target_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">test_formula_effects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a target_test argument into a list of effect names to test.</span>

<span class="sd">        Supports regular effect names (e.g. ``&quot;x1&quot;``, ``&quot;overall&quot;``),</span>
<span class="sd">        post-hoc pairwise comparison syntax ``&quot;factor[a] vs factor[b]&quot;``</span>
<span class="sd">        where ``a`` and ``b`` are 1-indexed user levels, keyword expansion,</span>
<span class="sd">        exclusion prefixes, and uniqueness validation.</span>

<span class="sd">        Keywords (case-insensitive):</span>
<span class="sd">            - ``&quot;all&quot;``: overall F-test + all individual fixed effects</span>
<span class="sd">              (no contrasts). This is the default.</span>
<span class="sd">            - ``&quot;all-posthoc&quot;``: all pairwise contrasts for every factor</span>
<span class="sd">              variable (C(n,2) pairs per factor).</span>

<span class="sd">        Exclusions:</span>
<span class="sd">            Prefix a test name with ``&quot;-&quot;`` to remove it from the expanded</span>
<span class="sd">            set, e.g. ``&quot;all, -overall&quot;`` or ``&quot;all-posthoc, -group[1] vs group[2]&quot;``.</span>

<span class="sd">        Uniqueness:</span>
<span class="sd">            Duplicate tests (e.g. ``&quot;all, x1&quot;`` where ``x1`` is already</span>
<span class="sd">            in the ``&quot;all&quot;`` expansion) raise ``ValueError``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">re_mod</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.core.variables</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostHocSpec</span>

        <span class="c1"># -- Phase 1: Tokenize ---------------------------------------------------</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_test</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">target_test</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_test</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_test</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

        <span class="c1"># -- Phase 2: Classify tokens --------------------------------------------</span>
        <span class="n">keywords</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exclusions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">explicit_tests</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">tok_lower</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tok_lower</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;all-posthoc&quot;</span><span class="p">}:</span>
                <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok_lower</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tok</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">explicit_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>

        <span class="c1"># -- Phase 3: Expand keywords --------------------------------------------</span>
        <span class="n">keyword_expansion</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cluster_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">cluster_effect_names</span>

        <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">test_formula_effects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fixed_effects</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">test_formula_effects</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cluster_effects</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fixed_effects</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">effect_names</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cluster_effects</span><span class="p">]</span>
            <span class="n">keyword_expansion</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fixed_effects</span>

        <span class="k">if</span> <span class="s2">&quot;all-posthoc&quot;</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="n">posthoc_from_keyword</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">factor_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">factor_names</span><span class="p">:</span>
                <span class="n">factor_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_factors</span><span class="p">[</span><span class="n">factor_name</span><span class="p">]</span>
                <span class="n">level_labels</span> <span class="o">=</span> <span class="n">factor_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level_labels&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">level_labels</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

                    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">level_labels</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">posthoc_from_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">] vs </span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n_levels</span> <span class="o">=</span> <span class="n">factor_info</span><span class="p">[</span><span class="s2">&quot;n_levels&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">posthoc_from_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">] vs </span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">posthoc_from_keyword</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keyword_expansion</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">explicit_tests</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;all-posthoc&#39; was specified but the model has no factor variables. Post-hoc contrasts require at least one factor.&quot;</span>
                <span class="p">)</span>
            <span class="n">keyword_expansion</span> <span class="o">+=</span> <span class="n">posthoc_from_keyword</span>

        <span class="c1"># -- Phase 4: Merge ------------------------------------------------------</span>
        <span class="n">expanded</span> <span class="o">=</span> <span class="n">keyword_expansion</span> <span class="o">+</span> <span class="n">explicit_tests</span>

        <span class="c1"># -- Phase 5: Apply dependent-variable alias ------------------------------</span>
        <span class="n">dep_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">dependent</span>
        <span class="n">alias_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">dep_var_name</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">}</span>
        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;overall&quot;</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">alias_set</span> <span class="k">else</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">]</span>
        <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;overall&quot;</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">alias_set</span> <span class="k">else</span> <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">]</span>

        <span class="c1"># -- Phase 6: Apply exclusions --------------------------------------------</span>
        <span class="k">for</span> <span class="n">excl</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">excl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exclusion &#39;-</span><span class="si">{</span><span class="n">excl</span><span class="si">}</span><span class="s2">&#39; does not match any test in the expanded set. Available tests: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expanded</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">expanded</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">excl</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">expanded</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All tests were excluded — nothing left to analyse.&quot;</span><span class="p">)</span>

        <span class="c1"># -- Phase 7: Validate uniqueness -----------------------------------------</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
            <span class="n">seen</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">seen</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Duplicate target test(s): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Each test may appear only once. If using keyword expansion &quot;</span>
                <span class="s2">&quot;(e.g. &#39;all&#39;), do not also list tests that are already included.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># -- Phase 7b: Validate explicit tests against test formula ----------------</span>
        <span class="k">if</span> <span class="n">test_formula_effects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_formula_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_formula_effects</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot; vs &quot;</span> <span class="ow">in</span> <span class="n">test</span> <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="s2">&quot;overall&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">test</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">test_formula_set</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Target test &#39;</span><span class="si">{</span><span class="n">test</span><span class="si">}</span><span class="s2">&#39; is not in the test formula. Available effects: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_formula_effects</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># -- Phase 8: Parse posthoc specs + validate ------------------------------</span>
        <span class="n">regular_tests</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">posthoc_specs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PostHocSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vs_pattern</span> <span class="o">=</span> <span class="n">re_mod</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\w+)\[([^\]]+)\]\s+vs\s+(\w+)\[([^\]]+)\]$&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">vs_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">factor_a</span><span class="p">,</span> <span class="n">level_a_str</span><span class="p">,</span> <span class="n">factor_b</span><span class="p">,</span> <span class="n">level_b_str</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="n">level_a</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span>
                <span class="n">level_b</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">level_a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level_a_str</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">level_a</span> <span class="o">=</span> <span class="n">level_a_str</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">level_b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level_b_str</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">level_b</span> <span class="o">=</span> <span class="n">level_b_str</span>

                <span class="k">if</span> <span class="n">factor_a</span> <span class="o">!=</span> <span class="n">factor_b</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Post-hoc comparison must be between levels of the same factor, got &#39;</span><span class="si">{</span><span class="n">factor_a</span><span class="si">}</span><span class="s2">&#39; vs &#39;</span><span class="si">{</span><span class="n">factor_b</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

                <span class="n">factor_name</span> <span class="o">=</span> <span class="n">factor_a</span>
                <span class="k">if</span> <span class="n">factor_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_factors</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Factor &#39;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">&#39; not found. Available factors: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_factors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">factor_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_factors</span><span class="p">[</span><span class="n">factor_name</span><span class="p">]</span>
                <span class="n">level_labels</span> <span class="o">=</span> <span class="n">factor_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level_labels&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">level_labels</span><span class="p">:</span>
                    <span class="c1"># Named levels -- validate against labels</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">level_a</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">level_labels</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Level &#39;</span><span class="si">{</span><span class="n">level_a</span><span class="si">}</span><span class="s2">&#39; not found for factor &#39;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">&#39;. Available: </span><span class="si">{</span><span class="n">level_labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">level_b</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">level_labels</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Level &#39;</span><span class="si">{</span><span class="n">level_b</span><span class="si">}</span><span class="s2">&#39; not found for factor &#39;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">&#39;. Available: </span><span class="si">{</span><span class="n">level_labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Integer levels -- existing validation</span>
                    <span class="n">n_levels</span> <span class="o">=</span> <span class="n">factor_info</span><span class="p">[</span><span class="s2">&quot;n_levels&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_a</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">level_a</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">level_a</span> <span class="o">&gt;</span> <span class="n">n_levels</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Level </span><span class="si">{</span><span class="n">level_a</span><span class="si">}</span><span class="s2"> out of range for factor &#39;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">&#39; (valid: 1 to </span><span class="si">{</span><span class="n">n_levels</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_b</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">level_b</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">level_b</span> <span class="o">&gt;</span> <span class="n">n_levels</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Level </span><span class="si">{</span><span class="n">level_b</span><span class="si">}</span><span class="s2"> out of range for factor &#39;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">&#39; (valid: 1 to </span><span class="si">{</span><span class="n">n_levels</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">level_a</span> <span class="o">==</span> <span class="n">level_b</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot compare a level to itself: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Map user 1-indexed levels to internal column indices in X_expanded</span>
                <span class="c1"># User level 1 = reference (no dummy → col_idx=None)</span>
                <span class="c1"># User level k (k≥2) = dummy factor[k]</span>
                <span class="n">effect_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_effects</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="c1"># Returns None for the reference level, which is absorbed into the</span>
                <span class="c1"># intercept in dummy coding and has no dedicated design matrix column.</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">_level_to_col</span><span class="p">(</span><span class="n">factor_name</span><span class="p">,</span> <span class="n">user_level</span><span class="p">,</span> <span class="n">_effect_order</span><span class="o">=</span><span class="n">effect_order</span><span class="p">):</span>
                    <span class="n">factor_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_factors</span><span class="p">[</span><span class="n">factor_name</span><span class="p">]</span>
                    <span class="n">reference</span> <span class="o">=</span> <span class="n">factor_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reference_level&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_level</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">reference</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># reference level</span>
                    <span class="n">dummy_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">user_level</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="k">if</span> <span class="n">dummy_name</span> <span class="ow">in</span> <span class="n">_effect_order</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">_effect_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dummy_name</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dummy &#39;</span><span class="si">{</span><span class="n">dummy_name</span><span class="si">}</span><span class="s2">&#39; not found in effects&quot;</span><span class="p">)</span>

                <span class="n">col_a</span> <span class="o">=</span> <span class="n">_level_to_col</span><span class="p">(</span><span class="n">factor_name</span><span class="p">,</span> <span class="n">level_a</span><span class="p">)</span>
                <span class="n">col_b</span> <span class="o">=</span> <span class="n">_level_to_col</span><span class="p">(</span><span class="n">factor_name</span><span class="p">,</span> <span class="n">level_b</span><span class="p">)</span>

                <span class="n">n_levels</span> <span class="o">=</span> <span class="n">factor_info</span><span class="p">[</span><span class="s2">&quot;n_levels&quot;</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">level_a</span><span class="si">}</span><span class="s2">] vs </span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">level_b</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="n">posthoc_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">PostHocSpec</span><span class="p">(</span>
                        <span class="n">factor_name</span><span class="o">=</span><span class="n">factor_name</span><span class="p">,</span>
                        <span class="n">level_a</span><span class="o">=</span><span class="n">level_a</span><span class="p">,</span>
                        <span class="n">level_b</span><span class="o">=</span><span class="n">level_b</span><span class="p">,</span>
                        <span class="n">col_idx_a</span><span class="o">=</span><span class="n">col_a</span><span class="p">,</span>
                        <span class="n">col_idx_b</span><span class="o">=</span><span class="n">col_b</span><span class="p">,</span>
                        <span class="n">n_levels</span><span class="o">=</span><span class="n">n_levels</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">regular_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">regular_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Store post-hoc specs on the model for metadata preparation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_posthoc_specs</span> <span class="o">=</span> <span class="n">posthoc_specs</span>

        <span class="c1"># Validate regular (non-posthoc) tests</span>
        <span class="n">cluster_in_targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">regular_tests</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cluster_effects</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cluster_in_targets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot test cluster effects </span><span class="si">{</span><span class="n">cluster_in_targets</span><span class="si">}</span><span class="s2"> - they are random effects. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Mixed models test fixed effects only. Use target_test=&#39;all&#39; or specify fixed effects.&quot;</span>
            <span class="p">)</span>

        <span class="n">valid_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">effect_names</span>
        <span class="n">posthoc_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">posthoc_specs</span><span class="p">}</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">regular_tests</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="s2">&quot;overall&quot;</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_effects</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">posthoc_labels</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">invalid</span><span class="p">:</span>
            <span class="n">valid_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">valid_effects</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cluster_effects</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid target test(s): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span><span class="si">}</span><span class="s2">. Available: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_options</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">regular_tests</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_X_extended</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the extended design matrix by adding interaction columns.</span>

<span class="sd">        Uses a cached effect plan to avoid re-inspecting the registry on</span>
<span class="sd">        every simulation iteration. Cluster random-effect columns are</span>
<span class="sd">        excluded (they are handled by the LME groups parameter).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Phase 2 Optimization: Build effect plan on first call, then reuse</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effect_plan_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_effect_plan_cache</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cluster_effect_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">cluster_effect_names</span>

            <span class="k">for</span> <span class="n">effect_name</span><span class="p">,</span> <span class="n">effect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_effects</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Skip cluster effects - they&#39;re handled separately via groups parameter in LME</span>
                <span class="k">if</span> <span class="n">effect_name</span> <span class="ow">in</span> <span class="n">cluster_effect_names</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">effect</span><span class="o">.</span><span class="n">effect_type</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_effect_plan_cache</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">effect</span><span class="o">.</span><span class="n">column_index</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_effect_plan_cache</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;interaction&quot;</span><span class="p">,</span> <span class="n">effect</span><span class="o">.</span><span class="n">column_indices</span><span class="p">))</span>

        <span class="c1"># Execute the cached plan</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">effect_type</span><span class="p">,</span> <span class="n">effect_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effect_plan_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">effect_type</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">:</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">effect_data</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># interaction</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">effect_data</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">col</span> <span class="o">*=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="k">if</span> <span class="n">columns</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_tests</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_formula_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pre-compute all static simulation metadata from the current model state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prepare_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_tests</span><span class="p">,</span> <span class="n">correction</span><span class="p">,</span> <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_test_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve test formula, validate, parse, and update _test_method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (formula_string, test_effect_names, random_effects).</span>
<span class="sd">            test_effect_names is None when test_formula is empty (use generation formula).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.parsers</span><span class="w"> </span><span class="kn">import</span> <span class="n">_parse_equation</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_formula</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">equation</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">random_effects</span> <span class="o">=</span> <span class="n">_parse_equation</span><span class="p">(</span><span class="n">resolved</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">random_effects</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_method</span> <span class="o">=</span> <span class="s2">&quot;mixed_model&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_method</span> <span class="o">=</span> <span class="s2">&quot;linear_regression&quot;</span>
            <span class="k">return</span> <span class="n">resolved</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>

        <span class="c1"># Validate test formula variables exist in the model</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">_validate_test_formula</span>

        <span class="n">available_vars</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">dependent</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">non_factor_names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">factor_names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">cluster_names</span>
        <span class="p">)</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="n">_validate_test_formula</span><span class="p">(</span><span class="n">test_formula</span><span class="p">,</span> <span class="n">available_vars</span><span class="p">)</span>
        <span class="n">validation</span><span class="o">.</span><span class="n">raise_if_invalid</span><span class="p">()</span>

        <span class="c1"># Parse test formula to get effects and random effects</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.test_formula_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_extract_test_formula_effects</span>

        <span class="n">test_effects</span><span class="p">,</span> <span class="n">random_effects</span> <span class="o">=</span> <span class="n">_extract_test_formula_effects</span><span class="p">(</span><span class="n">test_formula</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_effects</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test_formula &#39;</span><span class="si">{</span><span class="n">test_formula</span><span class="si">}</span><span class="s2">&#39; contains no testable effects from the data generation model.&quot;</span><span class="p">)</span>

        <span class="c1"># Check for OLS -&gt; LME cross (invalid: no cluster data to fit)</span>
        <span class="k">if</span> <span class="n">random_effects</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_cluster_specs</span><span class="p">:</span>
            <span class="n">grouping_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">[</span><span class="s2">&quot;grouping_var&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="n">random_effects</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;test_formula contains random effects (</span><span class="si">{</span><span class="n">grouping_vars</span><span class="si">}</span><span class="s2">) but the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;data generation model has no cluster structure. Cannot fit a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;mixed model to data without clusters.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">random_effects</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_method</span> <span class="o">=</span> <span class="s2">&quot;mixed_model&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_method</span> <span class="o">=</span> <span class="s2">&quot;linear_regression&quot;</span>

        <span class="k">return</span> <span class="n">test_formula</span><span class="p">,</span> <span class="n">test_effects</span><span class="p">,</span> <span class="n">random_effects</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_find_power</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">,</span>
        <span class="n">target_tests</span><span class="p">,</span>
        <span class="n">correction</span><span class="p">,</span>
        <span class="n">scenario_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test_formula_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test_random_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cancel_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the Monte Carlo simulation loop and return a power result dict.&quot;&quot;&quot;</span>
        <span class="c1"># Validate and adjust cluster sample sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_cluster_sample_size</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>

        <span class="c1"># Route based on test method (routing logic handled in simulation.py)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_metadata</span><span class="p">(</span><span class="n">target_tests</span><span class="p">,</span> <span class="n">correction</span><span class="p">,</span> <span class="n">test_formula_effects</span><span class="p">)</span>

        <span class="c1"># Set the random effects flag for test formula</span>
        <span class="k">if</span> <span class="n">test_random_effects</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">test_has_random_effects</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># scenario_config is always a dict (SCENARIO_ZERO or user-provided)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">heterogeneity</span> <span class="o">=</span> <span class="n">scenario_config</span><span class="p">[</span><span class="s2">&quot;heterogeneity&quot;</span><span class="p">]</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">heteroskedasticity</span> <span class="o">=</span> <span class="n">scenario_config</span><span class="p">[</span><span class="s2">&quot;heteroskedasticity&quot;</span><span class="p">]</span>

        <span class="n">runner</span> <span class="o">=</span> <span class="n">SimulationRunner</span><span class="p">(</span>
            <span class="n">n_simulations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_n_simulations</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">,</span>
            <span class="n">n_cores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cores</span><span class="p">,</span>
            <span class="n">max_failed_simulations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_failed_simulations</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Compute critical values once before the simulation loop</span>
        <span class="c1"># Use test formula&#39;s effect count for critical values when subsetting</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">test_column_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">test_effect_count</span>
            <span class="n">n_targets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">test_target_indices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">effect_sizes</span><span class="p">)</span>
            <span class="n">n_targets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">target_indices</span><span class="p">)</span>

        <span class="n">dof</span> <span class="o">=</span> <span class="n">sample_size</span> <span class="o">-</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">n_posthoc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">posthoc_specs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_posthoc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">posthoc_method</span> <span class="o">==</span> <span class="s2">&quot;t-test&quot;</span><span class="p">:</span>
            <span class="c1"># t-test post-hoc: combined correction family</span>
            <span class="n">n_combined</span> <span class="o">=</span> <span class="n">n_targets</span> <span class="o">+</span> <span class="n">n_posthoc</span>
            <span class="n">f_crit</span><span class="p">,</span> <span class="n">t_crit</span><span class="p">,</span> <span class="n">correction_t_crits_combined</span> <span class="o">=</span> <span class="n">compute_critical_values</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">p</span><span class="p">,</span>
                <span class="n">dof</span><span class="p">,</span>
                <span class="n">n_combined</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">.</span><span class="n">correction_method</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># For Bonferroni (same threshold for all), pass combined crits to regular analysis</span>
            <span class="c1"># For FDR/Holm, pass first n_targets crits to regular analysis (approximate;</span>
            <span class="c1"># exact combined correction is applied in compute_posthoc_contrasts)</span>
            <span class="n">correction_t_crits</span> <span class="o">=</span> <span class="n">correction_t_crits_combined</span><span class="p">[:</span><span class="n">n_targets</span><span class="p">]</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">posthoc_correction_t_crits_combined</span> <span class="o">=</span> <span class="n">correction_t_crits_combined</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No post-hoc or Tukey post-hoc: regular correction unchanged</span>
            <span class="n">f_crit</span><span class="p">,</span> <span class="n">t_crit</span><span class="p">,</span> <span class="n">correction_t_crits</span> <span class="o">=</span> <span class="n">compute_critical_values</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">p</span><span class="p">,</span>
                <span class="n">dof</span><span class="p">,</span>
                <span class="n">n_targets</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">.</span><span class="n">correction_method</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Store uncorrected t_crit for post-hoc use</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">posthoc_t_crit</span> <span class="o">=</span> <span class="n">t_crit</span>

        <span class="c1"># Compute Tukey critical values per factor (if Tukey method)</span>
        <span class="k">if</span> <span class="n">n_posthoc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">posthoc_method</span> <span class="o">==</span> <span class="s2">&quot;tukey&quot;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.stats.ols</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_tukey_critical_value</span>

            <span class="n">factors_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">posthoc_specs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">factor_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">factors_seen</span><span class="p">:</span>
                    <span class="n">factors_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">factor_name</span><span class="p">)</span>
                    <span class="n">metadata</span><span class="o">.</span><span class="n">posthoc_tukey_crits</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">factor_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_tukey_critical_value</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="n">spec</span><span class="o">.</span><span class="n">n_levels</span><span class="p">,</span>
                        <span class="n">dof</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># Create analyze function with precomputed critical values</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">analyze_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">correction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">get_backend</span><span class="p">()</span><span class="o">.</span><span class="n">ols_analysis</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">f_crit</span><span class="p">,</span> <span class="n">t_crit</span><span class="p">,</span> <span class="n">correction_t_crits</span><span class="p">,</span> <span class="n">correction</span><span class="p">)</span>

        <span class="n">sim_results</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_power_simulations</span><span class="p">(</span>
            <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">generate_y_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_dependent_variable</span><span class="p">,</span>
            <span class="n">analyze_func</span><span class="o">=</span><span class="n">analyze_func</span><span class="p">,</span>
            <span class="n">create_X_extended_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_X_extended</span><span class="p">,</span>
            <span class="n">scenario_config</span><span class="o">=</span><span class="n">scenario_config</span><span class="p">,</span>
            <span class="n">apply_perturbations_func</span><span class="o">=</span><span class="n">apply_per_simulation_perturbations</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="n">cancel_check</span><span class="o">=</span><span class="n">cancel_check</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># When test formula is active, filter target_tests to only effects in the test model</span>
        <span class="n">effective_target_tests</span> <span class="o">=</span> <span class="n">target_tests</span>
        <span class="k">if</span> <span class="n">test_formula_effects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_effect_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_formula_effects</span><span class="p">)</span>
            <span class="n">effective_target_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_tests</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;overall&quot;</span> <span class="ow">or</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">test_effect_set</span><span class="p">]</span>

        <span class="n">processor</span> <span class="o">=</span> <span class="n">ResultsProcessor</span><span class="p">(</span><span class="n">target_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">)</span>
        <span class="n">power_results</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">calculate_powers</span><span class="p">(</span>
            <span class="n">sim_results</span><span class="p">[</span><span class="s2">&quot;all_results&quot;</span><span class="p">],</span>
            <span class="n">sim_results</span><span class="p">[</span><span class="s2">&quot;all_results_corrected&quot;</span><span class="p">],</span>
            <span class="n">effective_target_tests</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add n_simulations_failed to power_results</span>
        <span class="k">if</span> <span class="s2">&quot;n_simulations_failed&quot;</span> <span class="ow">in</span> <span class="n">sim_results</span><span class="p">:</span>
            <span class="n">power_results</span><span class="p">[</span><span class="s2">&quot;n_simulations_failed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="s2">&quot;n_simulations_failed&quot;</span><span class="p">]</span>

        <span class="c1"># Tukey correction only applies to pairwise contrasts; NaN-ify others</span>
        <span class="k">if</span> <span class="n">correction</span> <span class="ow">and</span> <span class="n">correction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tukey&quot;</span> <span class="ow">and</span> <span class="n">power_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;individual_powers_corrected&quot;</span><span class="p">):</span>
            <span class="n">posthoc_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_posthoc_specs</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">effective_target_tests</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">test</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">posthoc_labels</span><span class="p">:</span>
                    <span class="n">power_results</span><span class="p">[</span><span class="s2">&quot;individual_powers_corrected&quot;</span><span class="p">][</span><span class="n">test</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">build_power_result</span><span class="p">(</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
            <span class="n">target_tests</span><span class="o">=</span><span class="n">effective_target_tests</span><span class="p">,</span>
            <span class="n">formula_to_test</span><span class="o">=</span><span class="n">test_formula</span><span class="p">,</span>
            <span class="n">equation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="p">,</span>
            <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">n_simulations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_n_simulations</span><span class="p">,</span>
            <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">,</span>
            <span class="n">target_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
            <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">,</span>
            <span class="n">power_results</span><span class="o">=</span><span class="n">power_results</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_parallel_effective</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve current parallel setting to a boolean.</span>

<span class="sd">        Returns True if parallel processing should be used for this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">==</span> <span class="s2">&quot;mixedmodels&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">_cluster_specs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_sample_size_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_sizes</span><span class="p">,</span>
        <span class="n">target_tests</span><span class="p">,</span>
        <span class="n">correction</span><span class="p">,</span>
        <span class="n">scenario_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test_formula_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test_random_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cancel_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over sample sizes, running power analysis for each.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.progress</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationCancelled</span>

        <span class="n">use_sequential</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_parallel_effective</span><span class="p">():</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">power_results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span>
                    <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cores</span><span class="p">,</span>
                    <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;loky&quot;</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span>
                <span class="p">)(</span>
                    <span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_find_power</span><span class="p">)(</span>
                        <span class="n">ss</span><span class="p">,</span>
                        <span class="n">target_tests</span><span class="p">,</span>
                        <span class="n">correction</span><span class="p">,</span>
                        <span class="n">scenario_config</span><span class="p">,</span>
                        <span class="n">test_formula</span><span class="p">,</span>
                        <span class="n">test_formula_effects</span><span class="p">,</span>
                        <span class="n">test_random_effects</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">sample_sizes</span>
                <span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ss</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">,</span> <span class="n">power_results</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cancel_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cancel_check</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">SimulationCancelled</span><span class="p">(</span><span class="s2">&quot;Simulation cancelled by user&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ss</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">progress</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_n_simulations</span><span class="p">)</span>
                <span class="n">use_sequential</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">SimulationCancelled</span><span class="p">):</span>
                    <span class="k">raise</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Parallel execution failed (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">). Falling back to sequential.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_sequential</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="n">sample_sizes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cancel_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cancel_check</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">SimulationCancelled</span><span class="p">(</span><span class="s2">&quot;Simulation cancelled by user&quot;</span><span class="p">)</span>
                <span class="n">power_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_find_power</span><span class="p">(</span>
                    <span class="n">sample_size</span><span class="p">,</span>
                    <span class="n">target_tests</span><span class="p">,</span>
                    <span class="n">correction</span><span class="p">,</span>
                    <span class="n">scenario_config</span><span class="p">,</span>
                    <span class="n">test_formula</span><span class="p">,</span>
                    <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">,</span>
                    <span class="n">test_random_effects</span><span class="o">=</span><span class="n">test_random_effects</span><span class="p">,</span>
                    <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                    <span class="n">cancel_check</span><span class="o">=</span><span class="n">cancel_check</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">power_result</span><span class="p">))</span>

        <span class="n">processor</span> <span class="o">=</span> <span class="n">ResultsProcessor</span><span class="p">(</span><span class="n">target_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">)</span>
        <span class="c1"># Filter target_tests to match test formula effects</span>
        <span class="k">if</span> <span class="n">test_formula_effects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_formula_effects</span><span class="p">)</span>
            <span class="n">effective_target_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_tests</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">test_set</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;overall&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">effective_target_tests</span> <span class="o">=</span> <span class="n">target_tests</span>

        <span class="n">analysis_results</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_sample_size_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">effective_target_tests</span><span class="p">,</span> <span class="n">correction</span><span class="p">)</span>

        <span class="c1"># Tukey correction only applies to pairwise contrasts; NaN-ify others</span>
        <span class="k">if</span> <span class="n">correction</span> <span class="ow">and</span> <span class="n">correction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tukey&quot;</span><span class="p">:</span>
            <span class="n">posthoc_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_posthoc_specs</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">analysis_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;powers_by_test_corrected&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">effective_target_tests</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">test</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">posthoc_labels</span><span class="p">:</span>
                        <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis_results</span><span class="p">[</span><span class="s2">&quot;powers_by_test_corrected&quot;</span><span class="p">][</span><span class="n">test</span><span class="p">])</span>
                        <span class="n">analysis_results</span><span class="p">[</span><span class="s2">&quot;powers_by_test_corrected&quot;</span><span class="p">][</span><span class="n">test</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n_points</span>
                        <span class="n">analysis_results</span><span class="p">[</span><span class="s2">&quot;first_achieved_corrected&quot;</span><span class="p">][</span><span class="n">test</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">build_sample_size_result</span><span class="p">(</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
            <span class="n">target_tests</span><span class="o">=</span><span class="n">effective_target_tests</span><span class="p">,</span>
            <span class="n">formula_to_test</span><span class="o">=</span><span class="n">test_formula</span><span class="p">,</span>
            <span class="n">equation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="p">,</span>
            <span class="n">sample_sizes</span><span class="o">=</span><span class="n">sample_sizes</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">n_simulations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_n_simulations</span><span class="p">,</span>
            <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">,</span>
            <span class="n">target_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
            <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">,</span>
            <span class="n">analysis_results</span><span class="o">=</span><span class="n">analysis_results</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_scenario_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delegate to ScenarioRunner for multi-scenario power or sample-size analysis.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

        <span class="n">all_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario_configs</span> <span class="ow">or</span> <span class="n">DEFAULT_SCENARIO_CONFIG</span>
        <span class="n">scenario_filter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;scenario_filter&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scenario_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">all_configs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">scenario_filter</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">configs</span> <span class="o">=</span> <span class="n">all_configs</span>
        <span class="n">scenario_runner</span> <span class="o">=</span> <span class="n">ScenarioRunner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configs</span><span class="p">)</span>
        <span class="n">test_formula</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_formula&quot;</span><span class="p">)</span>
        <span class="n">test_formula_effects</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_formula_effects&quot;</span><span class="p">)</span>
        <span class="n">test_random_effects</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_random_effects&quot;</span><span class="p">)</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;progress&quot;</span><span class="p">)</span>
        <span class="n">cancel_check</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cancel_check&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;power&quot;</span><span class="p">:</span>
            <span class="n">run_power_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_find_power</span><span class="p">,</span>
                <span class="n">test_formula</span><span class="o">=</span><span class="n">test_formula</span><span class="p">,</span>
                <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">,</span>
                <span class="n">test_random_effects</span><span class="o">=</span><span class="n">test_random_effects</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                <span class="n">cancel_check</span><span class="o">=</span><span class="n">cancel_check</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">scenario_runner</span><span class="o">.</span><span class="n">run_power_analysis</span><span class="p">(</span>
                <span class="n">sample_size</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">],</span>
                <span class="n">target_tests</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;target_tests&quot;</span><span class="p">],</span>
                <span class="n">correction</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction&quot;</span><span class="p">),</span>
                <span class="n">run_find_power_func</span><span class="o">=</span><span class="n">run_power_func</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;short&quot;</span><span class="p">),</span>
                <span class="n">print_results</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_results&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_ss_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_sample_size_analysis</span><span class="p">,</span>
                <span class="n">test_formula</span><span class="o">=</span><span class="n">test_formula</span><span class="p">,</span>
                <span class="n">test_formula_effects</span><span class="o">=</span><span class="n">test_formula_effects</span><span class="p">,</span>
                <span class="n">test_random_effects</span><span class="o">=</span><span class="n">test_random_effects</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                <span class="n">cancel_check</span><span class="o">=</span><span class="n">cancel_check</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">scenario_runner</span><span class="o">.</span><span class="n">run_sample_size_analysis</span><span class="p">(</span>
                <span class="n">sample_sizes</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">],</span>
                <span class="n">target_tests</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;target_tests&quot;</span><span class="p">],</span>
                <span class="n">correction</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction&quot;</span><span class="p">),</span>
                <span class="n">run_sample_size_func</span><span class="o">=</span><span class="n">run_ss_func</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;short&quot;</span><span class="p">),</span>
                <span class="n">print_results</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_results&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_sample_size_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create power-vs-sample-size plots (uncorrected and/or corrected).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction&quot;</span><span class="p">):</span>
            <span class="n">_create_power_plot</span><span class="p">(</span>
                <span class="n">sample_sizes</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;sample_sizes_tested&quot;</span><span class="p">],</span>
                <span class="n">powers_by_test</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;powers_by_test&quot;</span><span class="p">],</span>
                <span class="n">first_achieved</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;first_achieved&quot;</span><span class="p">],</span>
                <span class="n">target_tests</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;target_tests&quot;</span><span class="p">],</span>
                <span class="n">target_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Uncorrected Power&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_create_power_plot</span><span class="p">(</span>
                <span class="n">sample_sizes</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;sample_sizes_tested&quot;</span><span class="p">],</span>
                <span class="n">powers_by_test</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;powers_by_test_corrected&quot;</span><span class="p">],</span>
                <span class="n">first_achieved</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;first_achieved_corrected&quot;</span><span class="p">],</span>
                <span class="n">target_tests</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;target_tests&quot;</span><span class="p">],</span>
                <span class="n">target_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Corrected Power (</span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_create_power_plot</span><span class="p">(</span>
                <span class="n">sample_sizes</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;sample_sizes_tested&quot;</span><span class="p">],</span>
                <span class="n">powers_by_test</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;powers_by_test&quot;</span><span class="p">],</span>
                <span class="n">first_achieved</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;first_achieved&quot;</span><span class="p">],</span>
                <span class="n">target_tests</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;target_tests&quot;</span><span class="p">],</span>
                <span class="n">target_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Power Analysis&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;MCPower(equation=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="si">}</span><span class="s2">&#39;)&quot;</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025–2026, Paweł Lenartowicz
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/pawlenartowicz/MCPower" aria-label="GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=2bd037f0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>